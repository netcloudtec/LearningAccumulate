-- 加载三个表
-- 加载训练表
create table if not exists transaction_flow_train_tmp(
dd_date                string,
sd_fiid                string,
sd_tran_cde            string,
md_tran_amt1           string,
md_tran_amt2           string,
md_tran_amt3           string,
sd_msg_typ             string,
sd_apprv_cde           string,
sd_resp_cde            string,
sd_crd_vrfy_flg        string,
sd_cvd_present_flg     string,
sd_orig_crncy_cde      string,
sd_acq_inst_id_num     string,
sd_frwd_inst_id_num    string,
sd_retl_id             string,
sd_pt_srv_cond_cde     string,
sd_pt_srv_entry_mde    string,
sd_pin_ind             string,
sd_e_com_flg           string,
sd_track1_2_ind        string,
sd_auth_src            string,
sd_acct_typ            string,
sd_acct_stat           string,
sd_term_id             string,
sd_term_name_loc       string,
sd_pan                 string,
sd_pin_verify_flag     string,
sd_orig_wir_cntry_cde  string,
sd_retl_sic_cde        string,
sd_trace_nbr           string,
sd_proc_cde            string,
sd_tran_cde_cat        string,
sd_tranrspout          string,
nd_sign_accu           string,
sd_pin_chk             string,
sd_pin_flag            string,
sd_prod_ind            string,
sd_cityno              string,
sd_icflg               string,
sd_fall_back           string,
sd_visaeci_flag        string,
sd_mcucaf_flag         string,
sd_moto_flag           string
)
row format delimited 
  fields terminated by '|' 
  lines terminated by '\n'
stored as textfile;

load data local inpath '/opt/data/train.txt'  into  table transaction_flow_train_tmp;

-- 删除错列的行
create table if not exists transaction_flow_train stored as parquet as 
select * from transaction_flow_train_tmp where concat(sd_pan, SD_ORIG_WIR_CNTRY_CDE) rlike "^\\d+$"

-- 加载测试表
create table if not exists transaction_flow_test_tmp(
dd_date                string,
sd_fiid                string,
sd_tran_cde            string,
md_tran_amt1           string,
md_tran_amt2           string,
md_tran_amt3           string,
sd_msg_typ             string,
sd_apprv_cde           string,
sd_resp_cde            string,
sd_crd_vrfy_flg        string,
sd_cvd_present_flg     string,
sd_orig_crncy_cde      string,
sd_acq_inst_id_num     string,
sd_frwd_inst_id_num    string,
sd_retl_id             string,
sd_pt_srv_cond_cde     string,
sd_pt_srv_entry_mde    string,
sd_pin_ind             string,
sd_e_com_flg           string,
sd_track1_2_ind        string,
sd_auth_src            string,
sd_acct_typ            string,
sd_acct_stat           string,
sd_term_id             string,
sd_term_name_loc       string,
sd_pan                 string,
sd_pin_verify_flag     string,
sd_orig_wir_cntry_cde  string,
sd_retl_sic_cde        string,
sd_trace_nbr           string,
sd_proc_cde            string,
sd_tran_cde_cat        string,
sd_tranrspout          string,
nd_sign_accu           string,
sd_pin_chk             string,
sd_pin_flag            string,
sd_prod_ind            string,
sd_cityno              string,
sd_icflg               string,
sd_fall_back           string,
sd_visaeci_flag        string,
sd_mcucaf_flag         string,
sd_moto_flag           string
)
row format delimited 
  fields terminated by '|' 
  lines terminated by '\n'
stored as textfile;

load data local inpath '/opt/data/test.txt'  into  table transaction_flow_test;
-- 删除错行
create table if not exists transaction_flow_test stored as parquet as 
select * from transaction_flow_test_tmp where concat(sd_pan, SD_ORIG_WIR_CNTRY_CDE) rlike "^\\d+$"


-- 加载黑样本表
create table if not exists transaction_flow_black_tmp(
dd_date                string,
sd_fiid                string,
sd_tran_cde            string,
md_tran_amt1           string,
md_tran_amt2           string,
md_tran_amt3           string,
sd_msg_typ             string,
sd_apprv_cde           string,
sd_resp_cde            string,
sd_crd_vrfy_flg        string,
sd_cvd_present_flg     string,
sd_orig_crncy_cde      string,
sd_acq_inst_id_num     string,
sd_frwd_inst_id_num    string,
sd_retl_id             string,
sd_pt_srv_cond_cde     string,
sd_pt_srv_entry_mde    string,
sd_pin_ind             string,
sd_e_com_flg           string,
sd_track1_2_ind        string,
sd_auth_src            string,
sd_acct_typ            string,
sd_acct_stat           string,
sd_term_id             string,
sd_term_name_loc       string,
sd_pan                 string,
sd_pin_verify_flag     string,
sd_orig_wir_cntry_cde  string,
sd_retl_sic_cde        string,
sd_trace_nbr           string,
sd_proc_cde            string,
sd_tran_cde_cat        string,
sd_tranrspout          string,
nd_sign_accu           string,
sd_pin_chk             string,
sd_pin_flag            string,
sd_prod_ind            string,
sd_cityno              string,
sd_icflg               string,
sd_fall_back           string,
sd_visaeci_flag        string,
sd_mcucaf_flag         string,
sd_moto_flag           string
)
row format delimited 
  fields terminated by '|' 
  lines terminated by '\n'
stored as textfile;

load data local inpath '/opt/data/black.txt' into table transaction_flow_black_tmp;
-- 删除错行
create table if not exists transaction_flow_black stored as parquet as 
select * from transaction_flow_black_tmp where concat(sd_pan, SD_ORIG_WIR_CNTRY_CDE) rlike "^\\d+$"

-- 黑样本特征在整个train特征计算过程中只进行一次，在每次train白样本抽样特征计算结束后，与黑样本特征进行聚合
-- 假定黑卡交易记录表
-- 生成黑卡卡号 结果表为sd_pan_black
create table if not exists sd_pan_black stored as parquet as select distinct sd_pan from transaction_flow_black

-- 抽取黑卡卡号相关交易记录, 进行特征计算 结果表为 black_data_calc
create table if not exists black_data_calc stored as parquet as select * from transaction_flow_train left semi join sd_pan_black on transaction_flow_train.sd_pan = sd_pan_black.sd_pan

-- 特征计算，结果表为black_feature

create table if not exists transaction_flow_black_pre stored as parquet as select 
  dd_date,
  md_tran_amt1,
  sd_acq_inst_id_num,
  sd_frwd_inst_id_num,
  sd_pan,
  sd_trace_nbr,
  sd_tran_cde_cat,
  md_tran_amt3,
  substr(dd_date,1,8) local_date,
  substr(dd_date,10,8) local_time,
  (((((substr(dd_date, 10, 2) + (substr(dd_date, 13, 2) / 60)) + (substr(dd_date, 16, 2) / 3600)) / 24) * 2) * 3.141592653589793) time_to_radian,
  unix_timestamp(substr(dd_date,1,17),"yyyyMMdd hh:mm:ss") local_unix_timestamp,
  sd_orig_crncy_cde, 
  sd_orig_wir_cntry_cde,
  sd_cityno,
  sd_retl_sic_cde,
  sd_retl_id,
  case when sd_orig_wir_cntry_cde = 156  and sd_tran_cde_cat="PU" then md_tran_amt3 else null end china_amt,
  case when (not(sd_orig_wir_cntry_cde = 156)) and sd_tran_cde_cat="PU" then md_tran_amt3 else null end aboard_amt,
  case when (sd_orig_wir_cntry_cde in (840, 372, 250)) and sd_tran_cde_cat="PU" then md_tran_amt3 else null end high_risk_country_a_amt,
  case when (sd_retl_sic_cde in (5735, 4121)) and sd_tran_cde_cat="PU" then md_tran_amt3 else null end high_risk_mcc_code_a_amt
from 
  black_data_calc;
  


===========================================step01： 根据时间窗口统计 transaction_flow_black_time========================================== 

create table if not exists transaction_flow_black_time stored as parquet as select 
  dd_date,
  md_tran_amt1,
  sd_acq_inst_id_num,
  sd_frwd_inst_id_num,
  sd_pan,
  sd_trace_nbr,
  sd_tran_cde_cat,
  md_tran_amt3,
  local_date,
  local_time,
  time_to_radian,
  local_unix_timestamp,
  sd_orig_crncy_cde,  
  sd_orig_wir_cntry_cde,
  sd_cityno,
  sd_retl_sic_cde,
  sd_retl_id,
  china_amt,
  aboard_amt,
  high_risk_country_a_amt,
  high_risk_mcc_code_a_amt,
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_avg,
  
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600 preceding and 1 preceding) retl_id_tran_amt_1hour_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600 preceding and 1 preceding) retl_id_tran_amt_1hour_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_same_1hour_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600 preceding and 1 preceding) retl_id_same_1hour_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 3600 preceding and 1 preceding) cityno_same_1hour_count,
  
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) china_amt_1day_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) china_amt_1day_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) china_amt_1day_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) china_amt_1day_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) aboard_amt_1day_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) aboard_amt_1day_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) aboard_amt_1day_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) aboard_amt_1day_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_country_a_amt_1day_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_country_a_amt_1day_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_country_a_amt_1day_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_country_a_amt_1day_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 86400 preceding and 1 preceding) retl_id_tran_amt_1day_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 86400 preceding and 1 preceding) retl_id_tran_amt_1day_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_same_1day_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 86400 preceding and 1 preceding) retl_id_same_1day_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 86400 preceding and 1 preceding) cityno_same_1day_count,
 
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) china_amt_7day_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) china_amt_7day_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) china_amt_7day_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) china_amt_7day_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) aboard_amt_7day_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) aboard_amt_7day_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) aboard_amt_7day_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) aboard_amt_7day_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_country_a_amt_7day_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_country_a_amt_7day_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_country_a_amt_7day_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_country_a_amt_7day_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 604800 preceding and 1 preceding) retl_id_tran_amt_7day_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 604800 preceding and 1 preceding) retl_id_tran_amt_7day_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_same_7day_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 604800 preceding and 1 preceding) retl_id_same_7day_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 604800 preceding and 1 preceding) cityno_same_7day_count,
  
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) china_amt_15day_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) china_amt_15day_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) china_amt_15day_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) china_amt_15day_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) aboard_amt_15day_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) aboard_amt_15day_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) aboard_amt_15day_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) aboard_amt_15day_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_country_a_amt_15day_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_country_a_amt_15day_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_country_a_amt_15day_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_country_a_amt_15day_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 1296000 preceding and 1 preceding) retl_id_tran_amt_15day_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 1296000 preceding and 1 preceding) retl_id_tran_amt_15day_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_same_15day_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 1296000 preceding and 1 preceding) retl_id_same_15day_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 1296000 preceding and 1 preceding) cityno_same_15day_count,
  
  (local_unix_timestamp-lag(local_unix_timestamp, 1, NULL) over (partition by sd_pan order by local_unix_timestamp)) trans_time_interval,
  lag(sd_orig_wir_cntry_cde, 1, NULL) over (partition by sd_pan order by local_unix_timestamp) before_time_country
  

from
  transaction_flow_black_pre;
 
===========================================step02： 根据次数窗口统计 （transaction_flow_black_count）========================================== 
  
create table if not exists transaction_flow_black_count stored as parquet as  select 
  dd_date,
  md_tran_amt1,
  sd_acq_inst_id_num,
  sd_frwd_inst_id_num,
  sd_pan,
  sd_trace_nbr,
  sd_tran_cde_cat,
  md_tran_amt3,
  local_date,
  local_time,
  time_to_radian,
  local_unix_timestamp,
  sd_orig_crncy_cde,  
  sd_orig_wir_cntry_cde,
  sd_cityno,
  sd_retl_sic_cde,
  sd_retl_id,
  china_amt,
  aboard_amt,
  high_risk_country_a_amt,
  high_risk_mcc_code_a_amt,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding)  tran_amt_3num_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) tran_amt_3num_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) tran_amt_3num_avg,
  min(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) tran_amt_3num_min,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding)  china_amt_3num_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) china_amt_3num_avg,
  min(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) china_amt_3num_min,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding)  aboard_amt_3num_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) aboard_amt_3num_avg,
  min(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) aboard_amt_3num_min,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_country_a_amt_3num_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_country_a_amt_3num_avg,
  min(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_country_a_amt_3num_min,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_mcc_code_a_amt_3num_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_mcc_code_a_amt_3num_avg,
  min(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_mcc_code_a_amt_3num_min,

  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding)  tran_amt_7num_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) tran_amt_7num_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) tran_amt_7num_avg,
  min(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) tran_amt_7num_min,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding)  china_amt_7num_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) china_amt_7num_avg,
  min(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) china_amt_7num_min,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding)  aboard_amt_7num_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) aboard_amt_7num_avg,
  min(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) aboard_amt_7num_min,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_country_a_amt_7num_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_country_a_amt_7num_avg,
  min(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_country_a_amt_7num_min,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7num_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7num_avg,
  min(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7num_min,

  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding)  tran_amt_15num_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) tran_amt_15num_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) tran_amt_15num_avg,
  min(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) tran_amt_15num_min,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding)  china_amt_15num_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) china_amt_15num_avg,
  min(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) china_amt_15num_min,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding)  aboard_amt_15num_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) aboard_amt_15num_avg,
  min(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) aboard_amt_15num_min,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_country_a_amt_15num_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_country_a_amt_15num_avg,
  min(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_country_a_amt_15num_min,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15num_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15num_avg,
  min(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15num_min,
  
  case when (sd_orig_wir_cntry_cde - lag(sd_orig_wir_cntry_cde, 1, NULL) over (partition by sd_pan order by local_unix_timestamp))=0 then 1 else 0 end cntry_cde_before_same,
  case when (lag(china_amt, 1, NULL) over (partition by sd_pan order by local_unix_timestamp)>0 and  china_amt>0) then 1 else 0 end cntry_cde_before_same_china,
  
  lag(md_tran_amt3, 1, NULL) over (partition by sd_pan order by local_unix_timestamp) before_tran_amt
  
  from  
  transaction_flow_black_pre;
  
=====================================step03 将时间统计和次数统计 合并 transaction_flow_time_feature=================================
  
  
create table if not exists transaction_flow_black_time_feature stored as parquet as 
select 
  t1.dd_date,
  t1.md_tran_amt1,
  t1.sd_acq_inst_id_num,
  t1.sd_frwd_inst_id_num,
  t1.sd_pan,
  t1.sd_trace_nbr,
  t1.sd_tran_cde_cat,
  t1.md_tran_amt3,
  t1.local_date,
  t1.local_time,
  t1.time_to_radian,
  t1.local_unix_timestamp,
  t1.sd_orig_crncy_cde,  
  t1.sd_orig_wir_cntry_cde,
  t1.sd_cityno,
  t1.sd_retl_sic_cde,
  t1.sd_retl_id,
  t1.china_amt,
  t1.aboard_amt,
  t1.high_risk_country_a_amt,
  t1.high_risk_mcc_code_a_amt,
  t1.tran_amt_1hour_count,
  t1.tran_amt_1hour_sum,
  t1.tran_amt_1hour_max,
  t1.tran_amt_1hour_stddev,
  t1.tran_amt_1hour_avg,
  t1.china_amt_1hour_count,
  t1.china_amt_1hour_sum,
  t1.china_amt_1hour_max,
  t1.china_amt_1hour_avg,
  t1.aboard_amt_1hour_count,
  t1.aboard_amt_1hour_sum,
  t1.aboard_amt_1hour_max,
  t1.aboard_amt_1hour_avg,
  t1.high_risk_country_a_amt_1hour_count,
  t1.high_risk_country_a_amt_1hour_sum,
  t1.high_risk_country_a_amt_1hour_max,
  t1.high_risk_country_a_amt_1hour_avg,
  t1.high_risk_mcc_code_a_amt_1hour_count,
  t1.high_risk_mcc_code_a_amt_1hour_sum,
  t1.high_risk_mcc_code_a_amt_1hour_max,
  t1.high_risk_mcc_code_a_amt_1hour_avg,
  t1.retl_id_tran_amt_1hour_count,
  t1.retl_id_tran_amt_1hour_sum,
  t1.tran_same_1hour_count,
  t1.retl_id_same_1hour_count,
  t1.cityno_same_1hour_count,
  t1.tran_amt_1day_count,
  t1.tran_amt_1day_sum,
  t1.tran_amt_1day_max,
  t1.tran_amt_1day_stddev,
  t1.tran_amt_1day_avg,
  t1.china_amt_1day_count,
  t1.china_amt_1day_sum,
  t1.china_amt_1day_max,
  t1.china_amt_1day_avg,
  t1.aboard_amt_1day_count,
  t1.aboard_amt_1day_sum,
  t1.aboard_amt_1day_max,
  t1.aboard_amt_1day_avg,
  t1.high_risk_country_a_amt_1day_count,
  t1.high_risk_country_a_amt_1day_sum,
  t1.high_risk_country_a_amt_1day_max,
  t1.high_risk_country_a_amt_1day_avg,
  t1.high_risk_mcc_code_a_amt_1day_count,
  t1.high_risk_mcc_code_a_amt_1day_sum,
  t1.high_risk_mcc_code_a_amt_1day_max,
  t1.high_risk_mcc_code_a_amt_1day_avg,
  t1.retl_id_tran_amt_1day_count,
  t1.retl_id_tran_amt_1day_sum,
  t1.tran_same_1day_count,
  t1.retl_id_same_1day_count,
  t1.cityno_same_1day_count,
  
  t1.tran_amt_7day_count,
  t1.tran_amt_7day_sum,
  t1.tran_amt_7day_max,
  t1.tran_amt_7day_stddev,
  t1.tran_amt_7day_avg,
  t1.china_amt_7day_count,
  t1.china_amt_7day_sum,
  t1.china_amt_7day_max,
  t1.china_amt_7day_avg,
  t1.aboard_amt_7day_count,
  t1.aboard_amt_7day_sum,
  t1.aboard_amt_7day_max,
  t1.aboard_amt_7day_avg,
  t1.high_risk_country_a_amt_7day_count,
  t1.high_risk_country_a_amt_7day_sum,
  t1.high_risk_country_a_amt_7day_max,
  t1.high_risk_country_a_amt_7day_avg,
  t1.high_risk_mcc_code_a_amt_7day_count,
  t1.high_risk_mcc_code_a_amt_7day_sum,
  t1.high_risk_mcc_code_a_amt_7day_max,
  t1.high_risk_mcc_code_a_amt_7day_avg,
  t1.retl_id_tran_amt_7day_count,
  t1.retl_id_tran_amt_7day_sum,
  t1.tran_same_7day_count,
  t1.retl_id_same_7day_count,
  t1.cityno_same_7day_count,
  
  t1.tran_amt_15day_count,
  t1.tran_amt_15day_sum,
  t1.tran_amt_15day_max,
  t1.tran_amt_15day_stddev,
  t1.tran_amt_15day_avg,
  t1.china_amt_15day_count,
  t1.china_amt_15day_sum,
  t1.china_amt_15day_max,
  t1.china_amt_15day_avg,
  t1.aboard_amt_15day_count,
  t1.aboard_amt_15day_sum,
  t1.aboard_amt_15day_max,
  t1.aboard_amt_15day_avg,
  t1.high_risk_country_a_amt_15day_count,
  t1.high_risk_country_a_amt_15day_sum,
  t1.high_risk_country_a_amt_15day_max,
  t1.high_risk_country_a_amt_15day_avg,
  t1.high_risk_mcc_code_a_amt_15day_count,
  t1.high_risk_mcc_code_a_amt_15day_sum,
  t1.high_risk_mcc_code_a_amt_15day_max,
  t1.high_risk_mcc_code_a_amt_15day_avg,
  t1.retl_id_tran_amt_15day_count,
  t1.retl_id_tran_amt_15day_sum,
  t1.tran_same_15day_count,
  t1.retl_id_same_15day_count,
  t1.cityno_same_15day_count,
  
  t2.tran_amt_3num_max,
  t2.tran_amt_3num_stddev,
  t2.tran_amt_3num_avg,
  t2.tran_amt_3num_min,
  t2.china_amt_3num_max,
  t2.china_amt_3num_avg,
  t2.china_amt_3num_min,
  t2.aboard_amt_3num_max,
  t2.aboard_amt_3num_avg,
  t2.aboard_amt_3num_min,
  t2.high_risk_country_a_amt_3num_max,
  t2.high_risk_country_a_amt_3num_avg,
  t2.high_risk_country_a_amt_3num_min,
  t2.high_risk_mcc_code_a_amt_3num_max,
  t2.high_risk_mcc_code_a_amt_3num_avg,
  t2.high_risk_mcc_code_a_amt_3num_min,
  
  t2.tran_amt_7num_max,
  t2.tran_amt_7num_stddev,
  t2.tran_amt_7num_avg,
  t2.tran_amt_7num_min,
  t2.china_amt_7num_max,
  t2.china_amt_7num_avg,
  t2.china_amt_7num_min,
  t2.aboard_amt_7num_max,
  t2.aboard_amt_7num_avg,
  t2.aboard_amt_7num_min,
  t2.high_risk_country_a_amt_7num_max,
  t2.high_risk_country_a_amt_7num_avg,
  t2.high_risk_country_a_amt_7num_min,
  t2.high_risk_mcc_code_a_amt_7num_max,
  t2.high_risk_mcc_code_a_amt_7num_avg,
  t2.high_risk_mcc_code_a_amt_7num_min,
  
  t2.tran_amt_15num_max,
  t2.tran_amt_15num_stddev,
  t2.tran_amt_15num_avg,
  t2.tran_amt_15num_min,
  t2.china_amt_15num_max,
  t2.china_amt_15num_avg,
  t2.china_amt_15num_min,
  t2.aboard_amt_15num_max,
  t2.aboard_amt_15num_avg,
  t2.aboard_amt_15num_min,
  t2.high_risk_country_a_amt_15num_max,
  t2.high_risk_country_a_amt_15num_avg,
  t2.high_risk_country_a_amt_15num_min,
  t2.high_risk_mcc_code_a_amt_15num_max,
  t2.high_risk_mcc_code_a_amt_15num_avg,
  t2.high_risk_mcc_code_a_amt_15num_min,
  t2.cntry_cde_before_same,
  t2.cntry_cde_before_same_china,
  t2.before_tran_amt


from transaction_flow_black_time t1 left outer join transaction_flow_black_count t2 
on t1.sd_pan=t2.sd_pan and  t1.dd_date=t2.dd_date and t1.md_tran_amt1=t2.md_tran_amt1 and t1.sd_acq_inst_id_num=t2.sd_acq_inst_id_num 
and t1.sd_frwd_inst_id_num=t2.sd_frwd_inst_id_num and t1.sd_trace_nbr=t2.sd_trace_nbr and  t1.sd_tran_cde_cat=t2.sd_tran_cde_cat;

=========================================step03 计算 百分比的特征 ==================================
  
  
create table if not exists black_feature stored as parquet as select 
  dd_date,
  md_tran_amt1,
  sd_acq_inst_id_num,
  sd_frwd_inst_id_num,
  sd_pan,
  sd_trace_nbr,
  sd_tran_cde_cat,
  md_tran_amt3,
  local_date,
  local_time,
  time_to_radian,
  local_unix_timestamp,
  sd_orig_crncy_cde,  
  sd_orig_wir_cntry_cde,  
  sd_cityno,
  sd_retl_sic_cde,
  sd_retl_id,
  china_amt,
  aboard_amt,
  high_risk_country_a_amt,
  high_risk_mcc_code_a_amt,
  tran_amt_1hour_count,
  tran_amt_1hour_sum,
  tran_amt_1hour_max,
  tran_amt_1hour_stddev,
  tran_amt_1hour_avg,
  china_amt_1hour_count,
  china_amt_1hour_sum,
  china_amt_1hour_max,
  china_amt_1hour_avg,
  aboard_amt_1hour_count,
  aboard_amt_1hour_sum,
  aboard_amt_1hour_max,
  aboard_amt_1hour_avg,
  high_risk_country_a_amt_1hour_count,
  high_risk_country_a_amt_1hour_sum,
  high_risk_country_a_amt_1hour_max,
  high_risk_country_a_amt_1hour_avg,
  high_risk_mcc_code_a_amt_1hour_count,
  high_risk_mcc_code_a_amt_1hour_sum,
  high_risk_mcc_code_a_amt_1hour_max,
  high_risk_mcc_code_a_amt_1hour_avg,
  retl_id_tran_amt_1hour_count,
  retl_id_tran_amt_1hour_sum,
  tran_same_1hour_count,
  retl_id_same_1hour_count,
  cityno_same_1hour_count,
  tran_amt_1day_count,
  tran_amt_1day_sum,
  tran_amt_1day_max,
  tran_amt_1day_stddev,
  tran_amt_1day_avg,
  china_amt_1day_count,
  china_amt_1day_sum,
  china_amt_1day_max,
  china_amt_1day_avg,
  aboard_amt_1day_count,
  aboard_amt_1day_sum,
  aboard_amt_1day_max,
  aboard_amt_1day_avg,
  high_risk_country_a_amt_1day_count,
  high_risk_country_a_amt_1day_sum,
  high_risk_country_a_amt_1day_max,
  high_risk_country_a_amt_1day_avg,
  high_risk_mcc_code_a_amt_1day_count,
  high_risk_mcc_code_a_amt_1day_sum,
  high_risk_mcc_code_a_amt_1day_max,
  high_risk_mcc_code_a_amt_1day_avg,
  retl_id_tran_amt_1day_count,
  retl_id_tran_amt_1day_sum,
  tran_same_1day_count,
  retl_id_same_1day_count,
  cityno_same_1day_count,
  
  tran_amt_7day_count,
  tran_amt_7day_sum,
  tran_amt_7day_max,
  tran_amt_7day_stddev,
  tran_amt_7day_avg,
  china_amt_7day_count,
  china_amt_7day_sum,
  china_amt_7day_max,
  china_amt_7day_avg,
  aboard_amt_7day_count,
  aboard_amt_7day_sum,
  aboard_amt_7day_max,
  aboard_amt_7day_avg,
  high_risk_country_a_amt_7day_count,
  high_risk_country_a_amt_7day_sum,
  high_risk_country_a_amt_7day_max,
  high_risk_country_a_amt_7day_avg,
  high_risk_mcc_code_a_amt_7day_count,
  high_risk_mcc_code_a_amt_7day_sum,
  high_risk_mcc_code_a_amt_7day_max,
  high_risk_mcc_code_a_amt_7day_avg,
  retl_id_tran_amt_7day_count,
  retl_id_tran_amt_7day_sum,
  tran_same_7day_count,
  retl_id_same_7day_count,
  cityno_same_7day_count,
  
  tran_amt_15day_count,
  tran_amt_15day_sum,
  tran_amt_15day_max,
  tran_amt_15day_stddev,
  tran_amt_15day_avg,
  china_amt_15day_count,
  china_amt_15day_sum,
  china_amt_15day_max,
  china_amt_15day_avg,
  aboard_amt_15day_count,
  aboard_amt_15day_sum,
  aboard_amt_15day_max,
  aboard_amt_15day_avg,
  high_risk_country_a_amt_15day_count,
  high_risk_country_a_amt_15day_sum,
  high_risk_country_a_amt_15day_max,
  high_risk_country_a_amt_15day_avg,
  high_risk_mcc_code_a_amt_15day_count,
  high_risk_mcc_code_a_amt_15day_sum,
  high_risk_mcc_code_a_amt_15day_max,
  high_risk_mcc_code_a_amt_15day_avg,
  retl_id_tran_amt_15day_count,
  retl_id_tran_amt_15day_sum,
  tran_same_15day_count,
  retl_id_same_15day_count,
  cityno_same_15day_count,
  
  tran_amt_3num_max,
  tran_amt_3num_stddev,
  tran_amt_3num_avg,
  tran_amt_3num_min,
  china_amt_3num_max,
  china_amt_3num_avg,
  china_amt_3num_min,
  aboard_amt_3num_max,
  aboard_amt_3num_avg,
  aboard_amt_3num_min,
  high_risk_country_a_amt_3num_max,
  high_risk_country_a_amt_3num_avg,
  high_risk_country_a_amt_3num_min,
  high_risk_mcc_code_a_amt_3num_max,
  high_risk_mcc_code_a_amt_3num_avg,
  high_risk_mcc_code_a_amt_3num_min,
  tran_amt_7num_max,
  tran_amt_7num_stddev,
  tran_amt_7num_avg,
  tran_amt_7num_min,
  china_amt_7num_max,
  china_amt_7num_avg,
  china_amt_7num_min,
  aboard_amt_7num_max,
  aboard_amt_7num_avg,
  aboard_amt_7num_min,
  high_risk_country_a_amt_7num_max,
  high_risk_country_a_amt_7num_avg,
  high_risk_country_a_amt_7num_min,
  high_risk_mcc_code_a_amt_7num_max,
  high_risk_mcc_code_a_amt_7num_avg,
  high_risk_mcc_code_a_amt_7num_min,
  tran_amt_15num_max,
  tran_amt_15num_stddev,
  tran_amt_15num_avg,
  tran_amt_15num_min,
  china_amt_15num_max,
  china_amt_15num_avg,
  china_amt_15num_min,
  aboard_amt_15num_max,
  aboard_amt_15num_avg,
  aboard_amt_15num_min,
  high_risk_country_a_amt_15num_max,
  high_risk_country_a_amt_15num_avg,
  high_risk_country_a_amt_15num_min,
  high_risk_mcc_code_a_amt_15num_max,
  high_risk_mcc_code_a_amt_15num_avg,
  high_risk_mcc_code_a_amt_15num_min,
  cntry_cde_before_same,
  cntry_cde_before_same_china,
  before_tran_amt,
  (md_tran_amt3 / tran_amt_3num_avg) consume_amt_div_avg_3num,
  (md_tran_amt3 / tran_amt_3num_max) consume_amt_div_max_3num,
  (md_tran_amt3 / tran_amt_7num_avg) consume_amt_div_avg_7num,
  (md_tran_amt3 / tran_amt_7num_max) consume_amt_div_max_7num,
  (md_tran_amt3 / tran_amt_15num_avg) consume_amt_div_avg_15num,
  (md_tran_amt3 / tran_amt_15num_max) consume_amt_div_max_15num,
  (md_tran_amt3 / before_tran_amt) before_tran_amt_rate,
  (md_tran_amt3-tran_amt_15num_avg)/tran_amt_15num_stddev consume_amt_avg_div_stddev_15num,
  china_amt_1day_avg/china_amt_7day_avg china_amt_avg_1day_div_7day,
  china_amt_7day_avg/china_amt_15day_avg china_amt_avg_7day_div_15day,
  aboard_amt_1day_avg/aboard_amt_7day_avg aboard_amt_avg_1day_div_7day,
  aboard_amt_7day_avg/aboard_amt_15day_avg aboard_amt_avg_7day_div_15day,
  high_risk_country_a_amt_1day_avg/high_risk_country_a_amt_7day_avg high_risk_country_a_amt_avg_1day_div_7day,
  high_risk_country_a_amt_7day_avg/high_risk_country_a_amt_15day_avg high_risk_country_a_amt_avg_7day_div_15day,
  high_risk_mcc_code_a_amt_1day_avg/high_risk_mcc_code_a_amt_7day_avg high_risk_mcc_code_a_amt_avg_1day_div_7day,
  high_risk_mcc_code_a_amt_7day_avg/high_risk_mcc_code_a_amt_15day_avg high_risk_mcc_code_a_amt_avg_7day_div_15day,
  
  china_amt_3num_avg/china_amt_7num_avg china_amt_avg_3num_div_7num,
  china_amt_7num_avg/china_amt_15num_avg china_amt_avg_7num_div_15num,
  aboard_amt_3num_avg/aboard_amt_7num_avg aboard_amt_avg_3num_div_7num,
  aboard_amt_7num_avg/aboard_amt_15num_avg aboard_amt_avg_7num_div_15num,
  high_risk_country_a_amt_3num_avg/high_risk_country_a_amt_7num_avg high_risk_country_a_amt_avg_3num_div_7num,
  high_risk_country_a_amt_7num_avg/high_risk_country_a_amt_15num_avg high_risk_country_a_amt_avg_7num_div_15num,
  high_risk_mcc_code_a_amt_3num_avg/high_risk_mcc_code_a_amt_7num_avg high_risk_mcc_code_a_amt_avg_3num_div_7num,
  high_risk_mcc_code_a_amt_7num_avg/high_risk_mcc_code_a_amt_15num_avg high_risk_mcc_code_a_amt_avg_7num_div_15num
from
  transaction_flow_black_time_feature;


-- 从特征计算结果中选择出黑样本交易 结果表为 black_feature_final
create table if not exists black_feature_final stored as parquet as select * from black_feature left semi join (select * from transaction_flow_black) tmp on black_feature.dd_date = tmp.dd_date and black_feature.md_tran_amt1 = tmp.md_tran_amt1 and black_feature.sd_acq_inst_id_num = tmp.sd_acq_inst_id_num and black_feature.sd_frwd_inst_id_num = tmp.sd_frwd_inst_id_num and black_feature.sd_pan = tmp.sd_pan and black_feature.sd_trace_nbr = tmp.sd_trace_nbr and black_feature.sd_tran_cde_cat = tmp.sd_tran_cde_cat


----------------------------------------------训练集 白样本抽样重复20次(删除中间表，修改随机id取值范围和最终命名N) 特征计算------------------------------
-- 根据卡号抽样存在一个问题，数据是根据交易记录判断的黑白，如果说同一个卡号有两条交易记录，一黑一白，怎么办，这样会把白样本去除掉。
-- 下句二选一
-- 从卡号中删除黑卡，若存在Card 表，从card表中抽取卡号
create table if not exists sd_pan_white stored as parquet as select sd_pan from card left outer join sd_pan_black on card.sd_pan = sd_pan_black.sd_pan where sd_pan_black.sd_pan is null;
-- 从卡号中删除黑卡，若不存在Card 表，则从交易记录中distinct出所有卡号
create table if not exists sd_pan_white stored as parquet as select sd_pan from (select distinct sd_pan from transaction_flow_train) sd_pan_all left outer join sd_pan_black on sd_pan_all.sd_pan = sd_pan_black.sd_pan where sd_pan_black.sd_pan is null;

--为卡号打上1-100的随机id
create table if not exists sd_pan_white_rand stored as parquet as select cast(ceiling(rand() * 100) as int) rand_id_sd_pan,sd_pan from sd_pan_white;
 --抽取部分数据, 该数据可作为抽样数据的特征计算数据使用。
create table if not exists train_sample_part1 stored as parquet as select * from transaction_flow_train left semi join (select sd_pan from sd_pan_white_rand where rand_id_sd_pan<=5) tmp_b on transaction_flow_train.sd_pan=tmp_b.sd_pan;

-- 统计上一结果的数量，便于计算下一SQL的抽样比例
-- select count(*) from train_sample_part1 where md_tran_amt1 > 0

-- 在之前的基础上按照交易记录抽取部分数据
-- 为交易记录打上1-N的随机ID, 根据现场上一轮的抽样数量决定本句的抽样比例，进行交易记录抽样
create table if not exists train_sample_part2 stored as parquet as select dd_date, md_tran_amt1, sd_acq_inst_id_num, sd_frwd_inst_id_num, sd_pan, sd_trace_nbr, sd_tran_cde_cat from (select cast(ceiling(rand() * 100) as int) detail_rand_id, dd_date, md_tran_amt1, sd_acq_inst_id_num, sd_frwd_inst_id_num, sd_pan, sd_trace_nbr, sd_tran_cde_cat from train_sample_part1 where md_tran_amt1 > 0) tmp where tmp.detail_rand_id <= **;

-- 特征计算
-----------------------------------------------白样本单次抽样 特征计算-----------------------------
create table if not exists transaction_flow_train_pre stored as parquet as select 
  dd_date,
  md_tran_amt1,
  sd_acq_inst_id_num,
  sd_frwd_inst_id_num,
  sd_pan,
  sd_trace_nbr,
  sd_tran_cde_cat,
  md_tran_amt3,
  substr(dd_date,1,8) local_date,
  substr(dd_date,10,8) local_time,
  (((((substr(dd_date, 10, 2) + (substr(dd_date, 13, 2) / 60)) + (substr(dd_date, 16, 2) / 3600)) / 24) * 2) * 3.141592653589793) time_to_radian,
  unix_timestamp(substr(dd_date,1,17),"yyyyMMdd hh:mm:ss") local_unix_timestamp,
  sd_orig_crncy_cde, 
  sd_orig_wir_cntry_cde,
  sd_cityno,
  sd_retl_sic_cde,
  sd_retl_id,
  case when sd_orig_wir_cntry_cde = 156 then md_tran_amt3 else null end china_amt,
  case when (not(sd_orig_wir_cntry_cde = 156)) then md_tran_amt3 else null end aboard_amt,
  case when (sd_orig_wir_cntry_cde in (840, 372, 250)) then md_tran_amt3 else null end high_risk_country_a_amt,
  case when (sd_retl_sic_cde in (5735, 4121)) then md_tran_amt3 else null end high_risk_mcc_code_a_amt
from 
  train_sample_part1;
  


===========================================step01： 根据时间窗口统计 transaction_flow_time========================================== 

create table if not exists transaction_flow_train_time stored as parquet as select 
  dd_date,
  md_tran_amt1,
  sd_acq_inst_id_num,
  sd_frwd_inst_id_num,
  sd_pan,
  sd_trace_nbr,
  sd_tran_cde_cat,
  md_tran_amt3,
  local_date,
  local_time,
  time_to_radian,
  local_unix_timestamp,
  sd_orig_crncy_cde,  
  sd_orig_wir_cntry_cde,
  sd_cityno,
  sd_retl_sic_cde,
  sd_retl_id,
  china_amt,
  aboard_amt,
  high_risk_country_a_amt,
  high_risk_mcc_code_a_amt,
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_avg,
  
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600 preceding and 1 preceding) retl_id_tran_amt_1hour_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600 preceding and 1 preceding) retl_id_tran_amt_1hour_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_same_1hour_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600 preceding and 1 preceding) retl_id_same_1hour_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 3600 preceding and 1 preceding) cityno_same_1hour_count,
  
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) china_amt_1day_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) china_amt_1day_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) china_amt_1day_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) china_amt_1day_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) aboard_amt_1day_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) aboard_amt_1day_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) aboard_amt_1day_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) aboard_amt_1day_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_country_a_amt_1day_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_country_a_amt_1day_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_country_a_amt_1day_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_country_a_amt_1day_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 86400 preceding and 1 preceding) retl_id_tran_amt_1day_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 86400 preceding and 1 preceding) retl_id_tran_amt_1day_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_same_1day_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 86400 preceding and 1 preceding) retl_id_same_1day_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 86400 preceding and 1 preceding) cityno_same_1day_count,
 
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) china_amt_7day_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) china_amt_7day_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) china_amt_7day_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) china_amt_7day_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) aboard_amt_7day_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) aboard_amt_7day_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) aboard_amt_7day_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) aboard_amt_7day_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_country_a_amt_7day_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_country_a_amt_7day_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_country_a_amt_7day_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_country_a_amt_7day_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 604800 preceding and 1 preceding) retl_id_tran_amt_7day_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 604800 preceding and 1 preceding) retl_id_tran_amt_7day_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_same_7day_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 604800 preceding and 1 preceding) retl_id_same_7day_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 604800 preceding and 1 preceding) cityno_same_7day_count,
  
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) china_amt_15day_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) china_amt_15day_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) china_amt_15day_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) china_amt_15day_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) aboard_amt_15day_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) aboard_amt_15day_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) aboard_amt_15day_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) aboard_amt_15day_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_country_a_amt_15day_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_country_a_amt_15day_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_country_a_amt_15day_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_country_a_amt_15day_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 1296000 preceding and 1 preceding) retl_id_tran_amt_15day_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 1296000 preceding and 1 preceding) retl_id_tran_amt_15day_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_same_15day_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 1296000 preceding and 1 preceding) retl_id_same_15day_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 1296000 preceding and 1 preceding) cityno_same_15day_count,
  
  (local_unix_timestamp-lag(local_unix_timestamp, 1, NULL) over (partition by sd_pan order by local_unix_timestamp)) trans_time_interval,
  lag(sd_orig_wir_cntry_cde, 1, NULL) over (partition by sd_pan order by local_unix_timestamp) before_time_country
  

from
  transaction_flow_train_pre;
 
===========================================step02： 根据次数窗口统计 （transaction_flow_count）========================================== 
  
create table if not exists transaction_flow_train_count stored as parquet as  select 
  dd_date,
  md_tran_amt1,
  sd_acq_inst_id_num,
  sd_frwd_inst_id_num,
  sd_pan,
  sd_trace_nbr,
  sd_tran_cde_cat,
  md_tran_amt3,
  local_date,
  local_time,
  time_to_radian,
  local_unix_timestamp,
  sd_orig_crncy_cde,  
  sd_orig_wir_cntry_cde,
  sd_cityno,
  sd_retl_sic_cde,
  sd_retl_id,
  china_amt,
  aboard_amt,
  high_risk_country_a_amt,
  high_risk_mcc_code_a_amt,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding)  tran_amt_3num_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) tran_amt_3num_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) tran_amt_3num_avg,
  min(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) tran_amt_3num_min,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding)  china_amt_3num_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) china_amt_3num_avg,
  min(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) china_amt_3num_min,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding)  aboard_amt_3num_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) aboard_amt_3num_avg,
  min(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) aboard_amt_3num_min,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_country_a_amt_3num_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_country_a_amt_3num_avg,
  min(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_country_a_amt_3num_min,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_mcc_code_a_amt_3num_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_mcc_code_a_amt_3num_avg,
  min(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_mcc_code_a_amt_3num_min,

  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding)  tran_amt_7num_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) tran_amt_7num_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) tran_amt_7num_avg,
  min(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) tran_amt_7num_min,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding)  china_amt_7num_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) china_amt_7num_avg,
  min(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) china_amt_7num_min,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding)  aboard_amt_7num_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) aboard_amt_7num_avg,
  min(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) aboard_amt_7num_min,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_country_a_amt_7num_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_country_a_amt_7num_avg,
  min(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_country_a_amt_7num_min,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7num_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7num_avg,
  min(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7num_min,

  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding)  tran_amt_15num_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) tran_amt_15num_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) tran_amt_15num_avg,
  min(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) tran_amt_15num_min,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding)  china_amt_15num_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) china_amt_15num_avg,
  min(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) china_amt_15num_min,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding)  aboard_amt_15num_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) aboard_amt_15num_avg,
  min(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) aboard_amt_15num_min,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_country_a_amt_15num_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_country_a_amt_15num_avg,
  min(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_country_a_amt_15num_min,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15num_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15num_avg,
  min(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15num_min,
  
  case when (sd_orig_wir_cntry_cde - lag(sd_orig_wir_cntry_cde, 1, NULL) over (partition by sd_pan order by local_unix_timestamp))=0 then 1 else 0 end cntry_cde_before_same,
  case when (lag(china_amt, 1, NULL) over (partition by sd_pan order by local_unix_timestamp)>0 and  china_amt>0) then 1 else 0 end cntry_cde_before_same_china,
  
  lag(md_tran_amt3, 1, NULL) over (partition by sd_pan order by local_unix_timestamp) before_tran_amt
  
  from  
  transaction_flow_train_pre;
  
=====================================step03 将时间统计和次数统计 合并 transaction_flow_time_feature=================================
  
  
create table if not exists transaction_flow_train_time_feature stored as parquet as 
select 
  t1.dd_date,
  t1.md_tran_amt1,
  t1.sd_acq_inst_id_num,
  t1.sd_frwd_inst_id_num,
  t1.sd_pan,
  t1.sd_trace_nbr,
  t1.sd_tran_cde_cat,
  t1.md_tran_amt3,
  t1.local_date,
  t1.local_time,
  t1.time_to_radian,
  t1.local_unix_timestamp,
  t1.sd_orig_crncy_cde,  
  t1.sd_orig_wir_cntry_cde,
  t1.sd_cityno,
  t1.sd_retl_sic_cde,
  t1.sd_retl_id,
  t1.china_amt,
  t1.aboard_amt,
  t1.high_risk_country_a_amt,
  t1.high_risk_mcc_code_a_amt,
  t1.tran_amt_1hour_count,
  t1.tran_amt_1hour_sum,
  t1.tran_amt_1hour_max,
  t1.tran_amt_1hour_stddev,
  t1.tran_amt_1hour_avg,
  t1.china_amt_1hour_count,
  t1.china_amt_1hour_sum,
  t1.china_amt_1hour_max,
  t1.china_amt_1hour_avg,
  t1.aboard_amt_1hour_count,
  t1.aboard_amt_1hour_sum,
  t1.aboard_amt_1hour_max,
  t1.aboard_amt_1hour_avg,
  t1.high_risk_country_a_amt_1hour_count,
  t1.high_risk_country_a_amt_1hour_sum,
  t1.high_risk_country_a_amt_1hour_max,
  t1.high_risk_country_a_amt_1hour_avg,
  t1.high_risk_mcc_code_a_amt_1hour_count,
  t1.high_risk_mcc_code_a_amt_1hour_sum,
  t1.high_risk_mcc_code_a_amt_1hour_max,
  t1.high_risk_mcc_code_a_amt_1hour_avg,
  t1.retl_id_tran_amt_1hour_count,
  t1.retl_id_tran_amt_1hour_sum,
  t1.tran_same_1hour_count,
  t1.retl_id_same_1hour_count,
  t1.cityno_same_1hour_count,
  t1.tran_amt_1day_count,
  t1.tran_amt_1day_sum,
  t1.tran_amt_1day_max,
  t1.tran_amt_1day_stddev,
  t1.tran_amt_1day_avg,
  t1.china_amt_1day_count,
  t1.china_amt_1day_sum,
  t1.china_amt_1day_max,
  t1.china_amt_1day_avg,
  t1.aboard_amt_1day_count,
  t1.aboard_amt_1day_sum,
  t1.aboard_amt_1day_max,
  t1.aboard_amt_1day_avg,
  t1.high_risk_country_a_amt_1day_count,
  t1.high_risk_country_a_amt_1day_sum,
  t1.high_risk_country_a_amt_1day_max,
  t1.high_risk_country_a_amt_1day_avg,
  t1.high_risk_mcc_code_a_amt_1day_count,
  t1.high_risk_mcc_code_a_amt_1day_sum,
  t1.high_risk_mcc_code_a_amt_1day_max,
  t1.high_risk_mcc_code_a_amt_1day_avg,
  t1.retl_id_tran_amt_1day_count,
  t1.retl_id_tran_amt_1day_sum,
  t1.tran_same_1day_count,
  t1.retl_id_same_1day_count,
  t1.cityno_same_1day_count,
  
  t1.tran_amt_7day_count,
  t1.tran_amt_7day_sum,
  t1.tran_amt_7day_max,
  t1.tran_amt_7day_stddev,
  t1.tran_amt_7day_avg,
  t1.china_amt_7day_count,
  t1.china_amt_7day_sum,
  t1.china_amt_7day_max,
  t1.china_amt_7day_avg,
  t1.aboard_amt_7day_count,
  t1.aboard_amt_7day_sum,
  t1.aboard_amt_7day_max,
  t1.aboard_amt_7day_avg,
  t1.high_risk_country_a_amt_7day_count,
  t1.high_risk_country_a_amt_7day_sum,
  t1.high_risk_country_a_amt_7day_max,
  t1.high_risk_country_a_amt_7day_avg,
  t1.high_risk_mcc_code_a_amt_7day_count,
  t1.high_risk_mcc_code_a_amt_7day_sum,
  t1.high_risk_mcc_code_a_amt_7day_max,
  t1.high_risk_mcc_code_a_amt_7day_avg,
  t1.retl_id_tran_amt_7day_count,
  t1.retl_id_tran_amt_7day_sum,
  t1.tran_same_7day_count,
  t1.retl_id_same_7day_count,
  t1.cityno_same_7day_count,
  
  t1.tran_amt_15day_count,
  t1.tran_amt_15day_sum,
  t1.tran_amt_15day_max,
  t1.tran_amt_15day_stddev,
  t1.tran_amt_15day_avg,
  t1.china_amt_15day_count,
  t1.china_amt_15day_sum,
  t1.china_amt_15day_max,
  t1.china_amt_15day_avg,
  t1.aboard_amt_15day_count,
  t1.aboard_amt_15day_sum,
  t1.aboard_amt_15day_max,
  t1.aboard_amt_15day_avg,
  t1.high_risk_country_a_amt_15day_count,
  t1.high_risk_country_a_amt_15day_sum,
  t1.high_risk_country_a_amt_15day_max,
  t1.high_risk_country_a_amt_15day_avg,
  t1.high_risk_mcc_code_a_amt_15day_count,
  t1.high_risk_mcc_code_a_amt_15day_sum,
  t1.high_risk_mcc_code_a_amt_15day_max,
  t1.high_risk_mcc_code_a_amt_15day_avg,
  t1.retl_id_tran_amt_15day_count,
  t1.retl_id_tran_amt_15day_sum,
  t1.tran_same_15day_count,
  t1.retl_id_same_15day_count,
  t1.cityno_same_15day_count,
  
  t2.tran_amt_3num_max,
  t2.tran_amt_3num_stddev,
  t2.tran_amt_3num_avg,
  t2.china_amt_3num_max,
  t2.china_amt_3num_avg,
  t2.aboard_amt_3num_max,
  t2.aboard_amt_3num_avg,
  t2.high_risk_country_a_amt_3num_max,
  t2.high_risk_country_a_amt_3num_avg,
  t2.high_risk_mcc_code_a_amt_3num_max,
  t2.high_risk_mcc_code_a_amt_3num_avg,
  
  t2.tran_amt_7num_max,
  t2.tran_amt_7num_stddev,
  t2.tran_amt_7num_avg,
  t2.china_amt_7num_max,
  t2.china_amt_7num_avg,
  t2.aboard_amt_7num_max,
  t2.aboard_amt_7num_avg,
  t2.high_risk_country_a_amt_7num_max,
  t2.high_risk_country_a_amt_7num_avg,
  t2.high_risk_mcc_code_a_amt_7num_max,
  t2.high_risk_mcc_code_a_amt_7num_avg,
  
  t2.tran_amt_15num_max,
  t2.tran_amt_15num_stddev,
  t2.tran_amt_15num_avg,
  t2.china_amt_15num_max,
  t2.china_amt_15num_avg,
  t2.aboard_amt_15num_max,
  t2.aboard_amt_15num_avg,
  t2.high_risk_country_a_amt_15num_max,
  t2.high_risk_country_a_amt_15num_avg,
  t2.high_risk_mcc_code_a_amt_15num_max,
  t2.high_risk_mcc_code_a_amt_15num_avg,
  
  t2.cntry_cde_before_same,
  t2.cntry_cde_before_same_china,
  t2.before_tran_amt

from transaction_flow_train_time t1 left outer join transaction_flow_train_count t2 
on t1.sd_pan=t2.sd_pan and  t1.dd_date=t2.dd_date and t1.md_tran_amt1=t2.md_tran_amt1 and t1.sd_acq_inst_id_num=t2.sd_acq_inst_id_num 
and t1.sd_frwd_inst_id_num=t2.sd_frwd_inst_id_num and t1.sd_trace_nbr=t2.sd_trace_nbr and  t1.sd_tran_cde_cat=t2.sd_tran_cde_cat;




=========================================step03 计算 百分比的特征 ==================================
  
  
create table if not exists train_feature_final stored as parquet as select 
  dd_date,
  md_tran_amt1,
  sd_acq_inst_id_num,
  sd_frwd_inst_id_num,
  sd_pan,
  sd_trace_nbr,
  sd_tran_cde_cat,
  md_tran_amt3,
  local_date,
  local_time,
  time_to_radian,
  local_unix_timestamp,
  sd_orig_crncy_cde,  
  sd_orig_wir_cntry_cde,  
  sd_cityno,
  sd_retl_sic_cde,
  sd_retl_id,
  china_amt,
  aboard_amt,
  high_risk_country_a_amt,
  high_risk_mcc_code_a_amt,
  tran_amt_1hour_count,
  tran_amt_1hour_sum,
  tran_amt_1hour_max,
  tran_amt_1hour_stddev,
  tran_amt_1hour_avg,
  china_amt_1hour_count,
  china_amt_1hour_sum,
  china_amt_1hour_max,
  china_amt_1hour_avg,
  aboard_amt_1hour_count,
  aboard_amt_1hour_sum,
  aboard_amt_1hour_max,
  aboard_amt_1hour_avg,
  high_risk_country_a_amt_1hour_count,
  high_risk_country_a_amt_1hour_sum,
  high_risk_country_a_amt_1hour_max,
  high_risk_country_a_amt_1hour_avg,
  high_risk_mcc_code_a_amt_1hour_count,
  high_risk_mcc_code_a_amt_1hour_sum,
  high_risk_mcc_code_a_amt_1hour_max,
  high_risk_mcc_code_a_amt_1hour_avg,
  retl_id_tran_amt_1hour_count,
  retl_id_tran_amt_1hour_sum,
  tran_same_1hour_count,
  retl_id_same_1hour_count,
  cityno_same_1hour_count,
  tran_amt_1day_count,
  tran_amt_1day_sum,
  tran_amt_1day_max,
  tran_amt_1day_stddev,
  tran_amt_1day_avg,
  china_amt_1day_count,
  china_amt_1day_sum,
  china_amt_1day_max,
  china_amt_1day_avg,
  aboard_amt_1day_count,
  aboard_amt_1day_sum,
  aboard_amt_1day_max,
  aboard_amt_1day_avg,
  high_risk_country_a_amt_1day_count,
  high_risk_country_a_amt_1day_sum,
  high_risk_country_a_amt_1day_max,
  high_risk_country_a_amt_1day_avg,
  high_risk_mcc_code_a_amt_1day_count,
  high_risk_mcc_code_a_amt_1day_sum,
  high_risk_mcc_code_a_amt_1day_max,
  high_risk_mcc_code_a_amt_1day_avg,
  retl_id_tran_amt_1day_count,
  retl_id_tran_amt_1day_sum,
  tran_same_1day_count,
  retl_id_same_1day_count,
  cityno_same_1day_count,
  
  tran_amt_7day_count,
  tran_amt_7day_sum,
  tran_amt_7day_max,
  tran_amt_7day_stddev,
  tran_amt_7day_avg,
  china_amt_7day_count,
  china_amt_7day_sum,
  china_amt_7day_max,
  china_amt_7day_avg,
  aboard_amt_7day_count,
  aboard_amt_7day_sum,
  aboard_amt_7day_max,
  aboard_amt_7day_avg,
  high_risk_country_a_amt_7day_count,
  high_risk_country_a_amt_7day_sum,
  high_risk_country_a_amt_7day_max,
  high_risk_country_a_amt_7day_avg,
  high_risk_mcc_code_a_amt_7day_count,
  high_risk_mcc_code_a_amt_7day_sum,
  high_risk_mcc_code_a_amt_7day_max,
  high_risk_mcc_code_a_amt_7day_avg,
  retl_id_tran_amt_7day_count,
  retl_id_tran_amt_7day_sum,
  tran_same_7day_count,
  retl_id_same_7day_count,
  cityno_same_7day_count,
  
  tran_amt_15day_count,
  tran_amt_15day_sum,
  tran_amt_15day_max,
  tran_amt_15day_stddev,
  tran_amt_15day_avg,
  china_amt_15day_count,
  china_amt_15day_sum,
  china_amt_15day_max,
  china_amt_15day_avg,
  aboard_amt_15day_count,
  aboard_amt_15day_sum,
  aboard_amt_15day_max,
  aboard_amt_15day_avg,
  high_risk_country_a_amt_15day_count,
  high_risk_country_a_amt_15day_sum,
  high_risk_country_a_amt_15day_max,
  high_risk_country_a_amt_15day_avg,
  high_risk_mcc_code_a_amt_15day_count,
  high_risk_mcc_code_a_amt_15day_sum,
  high_risk_mcc_code_a_amt_15day_max,
  high_risk_mcc_code_a_amt_15day_avg,
  retl_id_tran_amt_15day_count,
  retl_id_tran_amt_15day_sum,
  tran_same_15day_count,
  retl_id_same_15day_count,
  cityno_same_15day_count,
  
  tran_amt_3num_max,
  tran_amt_3num_stddev,
  tran_amt_3num_avg,
  china_amt_3num_max,
  china_amt_3num_avg,
  aboard_amt_3num_max,
  aboard_amt_3num_avg,
  high_risk_country_a_amt_3num_max,
  high_risk_country_a_amt_3num_avg,
  high_risk_mcc_code_a_amt_3num_max,
  high_risk_mcc_code_a_amt_3num_avg,
  
  tran_amt_7num_max,
  tran_amt_7num_stddev,
  tran_amt_7num_avg,
  china_amt_7num_max,
  china_amt_7num_avg,
  aboard_amt_7num_max,
  aboard_amt_7num_avg,
  high_risk_country_a_amt_7num_max,
  high_risk_country_a_amt_7num_avg,
  high_risk_mcc_code_a_amt_7num_max,
  high_risk_mcc_code_a_amt_7num_avg,
  
  tran_amt_15num_max,
  tran_amt_15num_stddev,
  tran_amt_15num_avg,
  china_amt_15num_max,
  china_amt_15num_avg,
  aboard_amt_15num_max,
  aboard_amt_15num_avg,
  high_risk_country_a_amt_15num_max,
  high_risk_country_a_amt_15num_avg,
  high_risk_mcc_code_a_amt_15num_max,
  high_risk_mcc_code_a_amt_15num_avg,
  
  cntry_cde_before_same,
  cntry_cde_before_same_china,
  before_tran_amt,
  (md_tran_amt3 / tran_amt_3num_avg) consume_amt_div_avg_3num,
  (md_tran_amt3 / tran_amt_3num_max) consume_amt_div_max_3num,
  (md_tran_amt3 / tran_amt_7num_avg) consume_amt_div_avg_7num,
  (md_tran_amt3 / tran_amt_7num_max) consume_amt_div_max_7num,
  (md_tran_amt3 / tran_amt_15num_avg) consume_amt_div_avg_15num,
  (md_tran_amt3 / tran_amt_15num_max) consume_amt_div_max_15num,
  (md_tran_amt3 / before_tran_amt) before_tran_amt_rate,
  (md_tran_amt3-tran_amt_15num_avg)/tran_amt_15num_stddev consume_amt_avg_div_stddev_15num,
  china_amt_1day_avg/china_amt_7day_avg china_amt_avg_1day_div_7day,
  china_amt_7day_avg/china_amt_15day_avg china_amt_avg_7day_div_15day,
  aboard_amt_1day_avg/aboard_amt_7day_avg aboard_amt_avg_1day_div_7day,
  aboard_amt_7day_avg/aboard_amt_15day_avg aboard_amt_avg_7day_div_15day,
  high_risk_country_a_amt_1day_avg/high_risk_country_a_amt_7day_avg high_risk_country_a_amt_avg_1day_div_7day,
  high_risk_country_a_amt_7day_avg/high_risk_country_a_amt_15day_avg high_risk_country_a_amt_avg_7day_div_15day,
  high_risk_mcc_code_a_amt_1day_avg/high_risk_mcc_code_a_amt_7day_avg high_risk_mcc_code_a_amt_avg_1day_div_7day,
  high_risk_mcc_code_a_amt_7day_avg/high_risk_mcc_code_a_amt_15day_avg high_risk_mcc_code_a_amt_avg_7day_div_15day,
  
  china_amt_3num_avg/china_amt_7num_avg china_amt_avg_3num_div_7num,
  china_amt_7num_avg/china_amt_15num_avg china_amt_avg_7num_div_15num,
  aboard_amt_3num_avg/aboard_amt_7num_avg aboard_amt_avg_3num_div_7num,
  aboard_amt_7num_avg/aboard_amt_15num_avg aboard_amt_avg_7num_div_15num,
  high_risk_country_a_amt_3num_avg/high_risk_country_a_amt_7num_avg high_risk_country_a_amt_avg_3num_div_7num,
  high_risk_country_a_amt_7num_avg/high_risk_country_a_amt_15num_avg high_risk_country_a_amt_avg_7num_div_15num,
  high_risk_mcc_code_a_amt_3num_avg/high_risk_mcc_code_a_amt_7num_avg high_risk_mcc_code_a_amt_avg_3num_div_7num,
  high_risk_mcc_code_a_amt_7num_avg/high_risk_mcc_code_a_amt_15num_avg high_risk_mcc_code_a_amt_avg_7num_div_15num
from
  transaction_flow_train_time_feature;


-- 特征计算结束之后，从特征计算的结果中选择出之前抽样的交易记录(不确定left semi join是否可以用多字段判断，备选一)
create table if not exists train_data_final stored as parquet as select * from train_feature_final left semi join (select * from train_sample_part2) tmp on train_feature_final.dd_date = tmp.dd_date and train_feature_final.md_tran_amt1 = tmp.md_tran_amt1 and train_feature_final.sd_acq_inst_id_num = tmp.sd_acq_inst_id_num and train_feature_final.sd_frwd_inst_id_num = tmp.sd_frwd_inst_id_num and train_feature_final.sd_pan = tmp.sd_pan and train_feature_final.sd_trace_nbr = tmp.sd_trace_nbr and train_feature_final.sd_tran_cde_cat = tmp.sd_tran_cde_cat

-- 将黑白样本特征聚合
create table if not exists train_sample_N stored as parquet as select *, 0 as target from train_data_final union all select *, 1 as target from black_feature_final





