-- 加载训练集的最后一个月和测试集进行合并作为测试集特征计算的数据
create table if not exists test_data_calc stored as parquet as select * from transaction_flow_train where dd_date > "**" union all select * from transaction_flow_test;

-- 特征计算
-----------------------------------------------白样本单次抽样 特征计算-----------------------------
create table if not exists transaction_flow_test_pre stored as parquet as select 
  dd_date,
  md_tran_amt1,
  sd_acq_inst_id_num,
  sd_frwd_inst_id_num,
  sd_pan,
  sd_trace_nbr,
  sd_tran_cde_cat,
  md_tran_amt3,
  substr(dd_date,1,8) local_date,
  substr(dd_date,10,8) local_time,
  (((((substr(dd_date, 10, 2) + (substr(dd_date, 13, 2) / 60)) + (substr(dd_date, 16, 2) / 3600)) / 24) * 2) * 3.141592653589793) time_to_radian,
  unix_timestamp(substr(dd_date,1,17),"yyyyMMdd hh:mm:ss") local_unix_timestamp,
  sd_orig_crncy_cde, 
  sd_orig_wir_cntry_cde,
  sd_cityno,
  sd_retl_sic_cde,
  sd_retl_id,
  case when sd_orig_wir_cntry_cde = 156 then md_tran_amt3 else null end china_amt,
  case when (not(sd_orig_wir_cntry_cde = 156)) then md_tran_amt3 else null end aboard_amt,
  case when (sd_orig_wir_cntry_cde in (840, 372, 250)) then md_tran_amt3 else null end high_risk_country_a_amt,
  case when (sd_retl_sic_cde in (5735, 4121)) then md_tran_amt3 else null end high_risk_mcc_code_a_amt
from 
  test_data_calc;
  


===========================================step01： 根据时间窗口统计 transaction_flow_time========================================== 

create table if not exists transaction_flow_test_time stored as parquet as select 
  dd_date,
  md_tran_amt1,
  sd_acq_inst_id_num,
  sd_frwd_inst_id_num,
  sd_pan,
  sd_trace_nbr,
  sd_tran_cde_cat,
  md_tran_amt3,
  local_date,
  local_time,
  time_to_radian,
  local_unix_timestamp,
  sd_orig_crncy_cde,  
  sd_orig_wir_cntry_cde,
  sd_cityno,
  sd_retl_sic_cde,
  sd_retl_id,
  china_amt,
  aboard_amt,
  high_risk_country_a_amt,
  high_risk_mcc_code_a_amt,
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_avg,
  
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600 preceding and 1 preceding) retl_id_tran_amt_1hour_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600 preceding and 1 preceding) retl_id_tran_amt_1hour_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_same_1hour_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600 preceding and 1 preceding) retl_id_same_1hour_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 3600 preceding and 1 preceding) cityno_same_1hour_count,
  
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_amt_1day_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) china_amt_1day_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) china_amt_1day_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) china_amt_1day_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) china_amt_1day_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) aboard_amt_1day_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) aboard_amt_1day_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) aboard_amt_1day_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) aboard_amt_1day_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_country_a_amt_1day_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_country_a_amt_1day_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_country_a_amt_1day_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_country_a_amt_1day_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 86400 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 86400 preceding and 1 preceding) retl_id_tran_amt_1day_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 86400 preceding and 1 preceding) retl_id_tran_amt_1day_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 86400 preceding and 1 preceding) tran_same_1day_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 86400 preceding and 1 preceding) retl_id_same_1day_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 86400 preceding and 1 preceding) cityno_same_1day_count,
 
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_amt_7day_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) china_amt_7day_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) china_amt_7day_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) china_amt_7day_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) china_amt_7day_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) aboard_amt_7day_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) aboard_amt_7day_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) aboard_amt_7day_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) aboard_amt_7day_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_country_a_amt_7day_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_country_a_amt_7day_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_country_a_amt_7day_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_country_a_amt_7day_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 604800 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 604800 preceding and 1 preceding) retl_id_tran_amt_7day_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 604800 preceding and 1 preceding) retl_id_tran_amt_7day_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 604800 preceding and 1 preceding) tran_same_7day_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 604800 preceding and 1 preceding) retl_id_same_7day_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 604800 preceding and 1 preceding) cityno_same_7day_count,
  
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_amt_15day_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) china_amt_15day_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) china_amt_15day_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) china_amt_15day_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) china_amt_15day_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) aboard_amt_15day_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) aboard_amt_15day_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) aboard_amt_15day_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) aboard_amt_15day_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_country_a_amt_15day_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_country_a_amt_15day_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_country_a_amt_15day_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_country_a_amt_15day_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 1296000 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 1296000 preceding and 1 preceding) retl_id_tran_amt_15day_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 1296000 preceding and 1 preceding) retl_id_tran_amt_15day_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 1296000 preceding and 1 preceding) tran_same_15day_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 1296000 preceding and 1 preceding) retl_id_same_15day_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 1296000 preceding and 1 preceding) cityno_same_15day_count,
  
  (local_unix_timestamp-lag(local_unix_timestamp, 1, NULL) over (partition by sd_pan order by local_unix_timestamp)) trans_time_interval,
  lag(sd_orig_wir_cntry_cde, 1, NULL) over (partition by sd_pan order by local_unix_timestamp) before_time_country
  

from
  transaction_flow_test_pre;
 
===========================================step02： 根据次数窗口统计 （transaction_flow_count）========================================== 
  
create table if not exists transaction_flow_test_count stored as parquet as  select 
  dd_date,
  md_tran_amt1,
  sd_acq_inst_id_num,
  sd_frwd_inst_id_num,
  sd_pan,
  sd_trace_nbr,
  sd_tran_cde_cat,
  md_tran_amt3,
  local_date,
  local_time,
  time_to_radian,
  local_unix_timestamp,
  sd_orig_crncy_cde,  
  sd_orig_wir_cntry_cde,
  sd_cityno,
  sd_retl_sic_cde,
  sd_retl_id,
  china_amt,
  aboard_amt,
  high_risk_country_a_amt,
  high_risk_mcc_code_a_amt,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding)  tran_amt_3num_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) tran_amt_3num_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) tran_amt_3num_avg,
  min(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) tran_amt_3num_min,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding)  china_amt_3num_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) china_amt_3num_avg,
  min(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) china_amt_3num_min,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding)  aboard_amt_3num_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) aboard_amt_3num_avg,
  min(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) aboard_amt_3num_min,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_country_a_amt_3num_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_country_a_amt_3num_avg,
  min(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_country_a_amt_3num_min,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_mcc_code_a_amt_3num_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_mcc_code_a_amt_3num_avg,
  min(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 3 preceding and 1 preceding) high_risk_mcc_code_a_amt_3num_min,

  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding)  tran_amt_7num_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) tran_amt_7num_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) tran_amt_7num_avg,
  min(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) tran_amt_7num_min,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding)  china_amt_7num_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) china_amt_7num_avg,
  min(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) china_amt_7num_min,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding)  aboard_amt_7num_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) aboard_amt_7num_avg,
  min(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) aboard_amt_7num_min,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_country_a_amt_7num_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_country_a_amt_7num_avg,
  min(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_country_a_amt_7num_min,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7num_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7num_avg,
  min(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7num_min,

  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding)  tran_amt_15num_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) tran_amt_15num_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) tran_amt_15num_avg,
  min(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) tran_amt_15num_min,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding)  china_amt_15num_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) china_amt_15num_avg,
  min(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) china_amt_15num_min,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding)  aboard_amt_15num_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) aboard_amt_15num_avg,
  min(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) aboard_amt_15num_min,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_country_a_amt_15num_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_country_a_amt_15num_avg,
  min(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_country_a_amt_15num_min,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15num_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15num_avg,
  min(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15num_min,
  
  case when (sd_orig_wir_cntry_cde - lag(sd_orig_wir_cntry_cde, 1, NULL) over (partition by sd_pan order by local_unix_timestamp))=0 then 1 else 0 end cntry_cde_before_same,
  case when (lag(china_amt, 1, NULL) over (partition by sd_pan order by local_unix_timestamp)>0 and  china_amt>0) then 1 else 0 end cntry_cde_before_same_china,
  
  lag(md_tran_amt3, 1, NULL) over (partition by sd_pan order by local_unix_timestamp) before_tran_amt
  
  from  
  transaction_flow_test_pre;
  
=====================================step03 将时间统计和次数统计 合并 transaction_flow_time_feature=================================
  
  
create table if not exists transaction_flow_test_time_feature stored as parquet as 
select 
  t1.dd_date,
  t1.md_tran_amt1,
  t1.sd_acq_inst_id_num,
  t1.sd_frwd_inst_id_num,
  t1.sd_pan,
  t1.sd_trace_nbr,
  t1.sd_tran_cde_cat,
  t1.md_tran_amt3,
  t1.local_date,
  t1.local_time,
  t1.time_to_radian,
  t1.local_unix_timestamp,
  t1.sd_orig_crncy_cde,  
  t1.sd_orig_wir_cntry_cde,
  t1.sd_cityno,
  t1.sd_retl_sic_cde,
  t1.sd_retl_id,
  t1.china_amt,
  t1.aboard_amt,
  t1.high_risk_country_a_amt,
  t1.high_risk_mcc_code_a_amt,
  t1.tran_amt_1hour_count,
  t1.tran_amt_1hour_sum,
  t1.tran_amt_1hour_max,
  t1.tran_amt_1hour_stddev,
  t1.tran_amt_1hour_avg,
  t1.china_amt_1hour_count,
  t1.china_amt_1hour_sum,
  t1.china_amt_1hour_max,
  t1.china_amt_1hour_avg,
  t1.aboard_amt_1hour_count,
  t1.aboard_amt_1hour_sum,
  t1.aboard_amt_1hour_max,
  t1.aboard_amt_1hour_avg,
  t1.high_risk_country_a_amt_1hour_count,
  t1.high_risk_country_a_amt_1hour_sum,
  t1.high_risk_country_a_amt_1hour_max,
  t1.high_risk_country_a_amt_1hour_avg,
  t1.high_risk_mcc_code_a_amt_1hour_count,
  t1.high_risk_mcc_code_a_amt_1hour_sum,
  t1.high_risk_mcc_code_a_amt_1hour_max,
  t1.high_risk_mcc_code_a_amt_1hour_avg,
  t1.retl_id_tran_amt_1hour_count,
  t1.retl_id_tran_amt_1hour_sum,
  t1.tran_same_1hour_count,
  t1.retl_id_same_1hour_count,
  t1.cityno_same_1hour_count,
  t1.tran_amt_1day_count,
  t1.tran_amt_1day_sum,
  t1.tran_amt_1day_max,
  t1.tran_amt_1day_stddev,
  t1.tran_amt_1day_avg,
  t1.china_amt_1day_count,
  t1.china_amt_1day_sum,
  t1.china_amt_1day_max,
  t1.china_amt_1day_avg,
  t1.aboard_amt_1day_count,
  t1.aboard_amt_1day_sum,
  t1.aboard_amt_1day_max,
  t1.aboard_amt_1day_avg,
  t1.high_risk_country_a_amt_1day_count,
  t1.high_risk_country_a_amt_1day_sum,
  t1.high_risk_country_a_amt_1day_max,
  t1.high_risk_country_a_amt_1day_avg,
  t1.high_risk_mcc_code_a_amt_1day_count,
  t1.high_risk_mcc_code_a_amt_1day_sum,
  t1.high_risk_mcc_code_a_amt_1day_max,
  t1.high_risk_mcc_code_a_amt_1day_avg,
  t1.retl_id_tran_amt_1day_count,
  t1.retl_id_tran_amt_1day_sum,
  t1.tran_same_1day_count,
  t1.retl_id_same_1day_count,
  t1.cityno_same_1day_count,
  
  t1.tran_amt_7day_count,
  t1.tran_amt_7day_sum,
  t1.tran_amt_7day_max,
  t1.tran_amt_7day_stddev,
  t1.tran_amt_7day_avg,
  t1.china_amt_7day_count,
  t1.china_amt_7day_sum,
  t1.china_amt_7day_max,
  t1.china_amt_7day_avg,
  t1.aboard_amt_7day_count,
  t1.aboard_amt_7day_sum,
  t1.aboard_amt_7day_max,
  t1.aboard_amt_7day_avg,
  t1.high_risk_country_a_amt_7day_count,
  t1.high_risk_country_a_amt_7day_sum,
  t1.high_risk_country_a_amt_7day_max,
  t1.high_risk_country_a_amt_7day_avg,
  t1.high_risk_mcc_code_a_amt_7day_count,
  t1.high_risk_mcc_code_a_amt_7day_sum,
  t1.high_risk_mcc_code_a_amt_7day_max,
  t1.high_risk_mcc_code_a_amt_7day_avg,
  t1.retl_id_tran_amt_7day_count,
  t1.retl_id_tran_amt_7day_sum,
  t1.tran_same_7day_count,
  t1.retl_id_same_7day_count,
  t1.cityno_same_7day_count,
  
  t1.tran_amt_15day_count,
  t1.tran_amt_15day_sum,
  t1.tran_amt_15day_max,
  t1.tran_amt_15day_stddev,
  t1.tran_amt_15day_avg,
  t1.china_amt_15day_count,
  t1.china_amt_15day_sum,
  t1.china_amt_15day_max,
  t1.china_amt_15day_avg,
  t1.aboard_amt_15day_count,
  t1.aboard_amt_15day_sum,
  t1.aboard_amt_15day_max,
  t1.aboard_amt_15day_avg,
  t1.high_risk_country_a_amt_15day_count,
  t1.high_risk_country_a_amt_15day_sum,
  t1.high_risk_country_a_amt_15day_max,
  t1.high_risk_country_a_amt_15day_avg,
  t1.high_risk_mcc_code_a_amt_15day_count,
  t1.high_risk_mcc_code_a_amt_15day_sum,
  t1.high_risk_mcc_code_a_amt_15day_max,
  t1.high_risk_mcc_code_a_amt_15day_avg,
  t1.retl_id_tran_amt_15day_count,
  t1.retl_id_tran_amt_15day_sum,
  t1.tran_same_15day_count,
  t1.retl_id_same_15day_count,
  t1.cityno_same_15day_count,
  
   t2.tran_amt_3num_max,
  t2.tran_amt_3num_stddev,
  t2.tran_amt_3num_avg,
  t2.tran_amt_3num_min,
  t2.china_amt_3num_max,
  t2.china_amt_3num_avg,
  t2.china_amt_3num_min,
  t2.aboard_amt_3num_max,
  t2.aboard_amt_3num_avg,
  t2.aboard_amt_3num_min,
  t2.high_risk_country_a_amt_3num_max,
  t2.high_risk_country_a_amt_3num_avg,
  t2.high_risk_country_a_amt_3num_min,
  t2.high_risk_mcc_code_a_amt_3num_max,
  t2.high_risk_mcc_code_a_amt_3num_avg,
  t2.high_risk_mcc_code_a_amt_3num_min,
  
  t2.tran_amt_7num_max,
  t2.tran_amt_7num_stddev,
  t2.tran_amt_7num_avg,
  t2.tran_amt_7num_min,
  t2.china_amt_7num_max,
  t2.china_amt_7num_avg,
  t2.china_amt_7num_min,
  t2.aboard_amt_7num_max,
  t2.aboard_amt_7num_avg,
  t2.aboard_amt_7num_min,
  t2.high_risk_country_a_amt_7num_max,
  t2.high_risk_country_a_amt_7num_avg,
  t2.high_risk_country_a_amt_7num_min,
  t2.high_risk_mcc_code_a_amt_7num_max,
  t2.high_risk_mcc_code_a_amt_7num_avg,
  t2.high_risk_mcc_code_a_amt_7num_min,
  
  t2.tran_amt_15num_max,
  t2.tran_amt_15num_stddev,
  t2.tran_amt_15num_avg,
  t2.tran_amt_15num_min,
  t2.china_amt_15num_max,
  t2.china_amt_15num_avg,
  t2.china_amt_15num_min,
  t2.aboard_amt_15num_max,
  t2.aboard_amt_15num_avg,
  t2.aboard_amt_15num_min,
  t2.high_risk_country_a_amt_15num_max,
  t2.high_risk_country_a_amt_15num_avg,
  t2.high_risk_country_a_amt_15num_min,
  t2.high_risk_mcc_code_a_amt_15num_max,
  t2.high_risk_mcc_code_a_amt_15num_avg,
  t2.high_risk_mcc_code_a_amt_15num_min,
  t2.cntry_cde_before_same,
  t2.cntry_cde_before_same_china,
  t2.before_tran_amt


from transaction_flow_test_time t1 left outer join transaction_flow_test_count t2 
on t1.sd_pan=t2.sd_pan and  t1.dd_date=t2.dd_date and t1.md_tran_amt1=t2.md_tran_amt1 and t1.sd_acq_inst_id_num=t2.sd_acq_inst_id_num 
and t1.sd_frwd_inst_id_num=t2.sd_frwd_inst_id_num and t1.sd_trace_nbr=t2.sd_trace_nbr and  t1.sd_tran_cde_cat=t2.sd_tran_cde_cat;




=========================================step03 计算 百分比的特征 ==================================
  
  
create table if not exists test_feature_final stored as parquet as select 
  dd_date,
  md_tran_amt1,
  sd_acq_inst_id_num,
  sd_frwd_inst_id_num,
  sd_pan,
  sd_trace_nbr,
  sd_tran_cde_cat,
  md_tran_amt3,
  local_date,
  local_time,
  time_to_radian,
  local_unix_timestamp,
  sd_orig_crncy_cde,  
  sd_orig_wir_cntry_cde,  
  sd_cityno,
  sd_retl_sic_cde,
  sd_retl_id,
  china_amt,
  aboard_amt,
  high_risk_country_a_amt,
  high_risk_mcc_code_a_amt,
  tran_amt_1hour_count,
  tran_amt_1hour_sum,
  tran_amt_1hour_max,
  tran_amt_1hour_stddev,
  tran_amt_1hour_avg,
  china_amt_1hour_count,
  china_amt_1hour_sum,
  china_amt_1hour_max,
  china_amt_1hour_avg,
  aboard_amt_1hour_count,
  aboard_amt_1hour_sum,
  aboard_amt_1hour_max,
  aboard_amt_1hour_avg,
  high_risk_country_a_amt_1hour_count,
  high_risk_country_a_amt_1hour_sum,
  high_risk_country_a_amt_1hour_max,
  high_risk_country_a_amt_1hour_avg,
  high_risk_mcc_code_a_amt_1hour_count,
  high_risk_mcc_code_a_amt_1hour_sum,
  high_risk_mcc_code_a_amt_1hour_max,
  high_risk_mcc_code_a_amt_1hour_avg,
  retl_id_tran_amt_1hour_count,
  retl_id_tran_amt_1hour_sum,
  tran_same_1hour_count,
  retl_id_same_1hour_count,
  cityno_same_1hour_count,
  tran_amt_1day_count,
  tran_amt_1day_sum,
  tran_amt_1day_max,
  tran_amt_1day_stddev,
  tran_amt_1day_avg,
  china_amt_1day_count,
  china_amt_1day_sum,
  china_amt_1day_max,
  china_amt_1day_avg,
  aboard_amt_1day_count,
  aboard_amt_1day_sum,
  aboard_amt_1day_max,
  aboard_amt_1day_avg,
  high_risk_country_a_amt_1day_count,
  high_risk_country_a_amt_1day_sum,
  high_risk_country_a_amt_1day_max,
  high_risk_country_a_amt_1day_avg,
  high_risk_mcc_code_a_amt_1day_count,
  high_risk_mcc_code_a_amt_1day_sum,
  high_risk_mcc_code_a_amt_1day_max,
  high_risk_mcc_code_a_amt_1day_avg,
  retl_id_tran_amt_1day_count,
  retl_id_tran_amt_1day_sum,
  tran_same_1day_count,
  retl_id_same_1day_count,
  cityno_same_1day_count,
  
  tran_amt_7day_count,
  tran_amt_7day_sum,
  tran_amt_7day_max,
  tran_amt_7day_stddev,
  tran_amt_7day_avg,
  china_amt_7day_count,
  china_amt_7day_sum,
  china_amt_7day_max,
  china_amt_7day_avg,
  aboard_amt_7day_count,
  aboard_amt_7day_sum,
  aboard_amt_7day_max,
  aboard_amt_7day_avg,
  high_risk_country_a_amt_7day_count,
  high_risk_country_a_amt_7day_sum,
  high_risk_country_a_amt_7day_max,
  high_risk_country_a_amt_7day_avg,
  high_risk_mcc_code_a_amt_7day_count,
  high_risk_mcc_code_a_amt_7day_sum,
  high_risk_mcc_code_a_amt_7day_max,
  high_risk_mcc_code_a_amt_7day_avg,
  retl_id_tran_amt_7day_count,
  retl_id_tran_amt_7day_sum,
  tran_same_7day_count,
  retl_id_same_7day_count,
  cityno_same_7day_count,
  
  tran_amt_15day_count,
  tran_amt_15day_sum,
  tran_amt_15day_max,
  tran_amt_15day_stddev,
  tran_amt_15day_avg,
  china_amt_15day_count,
  china_amt_15day_sum,
  china_amt_15day_max,
  china_amt_15day_avg,
  aboard_amt_15day_count,
  aboard_amt_15day_sum,
  aboard_amt_15day_max,
  aboard_amt_15day_avg,
  high_risk_country_a_amt_15day_count,
  high_risk_country_a_amt_15day_sum,
  high_risk_country_a_amt_15day_max,
  high_risk_country_a_amt_15day_avg,
  high_risk_mcc_code_a_amt_15day_count,
  high_risk_mcc_code_a_amt_15day_sum,
  high_risk_mcc_code_a_amt_15day_max,
  high_risk_mcc_code_a_amt_15day_avg,
  retl_id_tran_amt_15day_count,
  retl_id_tran_amt_15day_sum,
  tran_same_15day_count,
  retl_id_same_15day_count,
  cityno_same_15day_count,
  
  tran_amt_3num_max,
  tran_amt_3num_stddev,
  tran_amt_3num_avg,
  tran_amt_3num_min,
  china_amt_3num_max,
  china_amt_3num_avg,
  china_amt_3num_min,
  aboard_amt_3num_max,
  aboard_amt_3num_avg,
  aboard_amt_3num_min,
  high_risk_country_a_amt_3num_max,
  high_risk_country_a_amt_3num_avg,
  high_risk_country_a_amt_3num_min,
  high_risk_mcc_code_a_amt_3num_max,
  high_risk_mcc_code_a_amt_3num_avg,
  high_risk_mcc_code_a_amt_3num_min,
  tran_amt_7num_max,
  tran_amt_7num_stddev,
  tran_amt_7num_avg,
  tran_amt_7num_min,
  china_amt_7num_max,
  china_amt_7num_avg,
  china_amt_7num_min,
  aboard_amt_7num_max,
  aboard_amt_7num_avg,
  aboard_amt_7num_min,
  high_risk_country_a_amt_7num_max,
  high_risk_country_a_amt_7num_avg,
  high_risk_country_a_amt_7num_min,
  high_risk_mcc_code_a_amt_7num_max,
  high_risk_mcc_code_a_amt_7num_avg,
  high_risk_mcc_code_a_amt_7num_min,
  tran_amt_15num_max,
  tran_amt_15num_stddev,
  tran_amt_15num_avg,
  tran_amt_15num_min,
  china_amt_15num_max,
  china_amt_15num_avg,
  china_amt_15num_min,
  aboard_amt_15num_max,
  aboard_amt_15num_avg,
  aboard_amt_15num_min,
  high_risk_country_a_amt_15num_max,
  high_risk_country_a_amt_15num_avg,
  high_risk_country_a_amt_15num_min,
  high_risk_mcc_code_a_amt_15num_max,
  high_risk_mcc_code_a_amt_15num_avg,
  high_risk_mcc_code_a_amt_15num_min,
  cntry_cde_before_same,
  cntry_cde_before_same_china,
  before_tran_amt,
  (md_tran_amt3 / tran_amt_3num_avg) consume_amt_div_avg_3num,
  (md_tran_amt3 / tran_amt_3num_max) consume_amt_div_max_3num,
  (md_tran_amt3 / tran_amt_7num_avg) consume_amt_div_avg_7num,
  (md_tran_amt3 / tran_amt_7num_max) consume_amt_div_max_7num,
  (md_tran_amt3 / tran_amt_15num_avg) consume_amt_div_avg_15num,
  (md_tran_amt3 / tran_amt_15num_max) consume_amt_div_max_15num,
  (md_tran_amt3 / before_tran_amt) before_tran_amt_rate,
  (md_tran_amt3-tran_amt_15num_avg)/tran_amt_15num_stddev consume_amt_avg_div_stddev_15num,
  china_amt_1day_avg/china_amt_7day_avg china_amt_avg_1day_div_7day,
  china_amt_7day_avg/china_amt_15day_avg china_amt_avg_7day_div_15day,
  aboard_amt_1day_avg/aboard_amt_7day_avg aboard_amt_avg_1day_div_7day,
  aboard_amt_7day_avg/aboard_amt_15day_avg aboard_amt_avg_7day_div_15day,
  high_risk_country_a_amt_1day_avg/high_risk_country_a_amt_7day_avg high_risk_country_a_amt_avg_1day_div_7day,
  high_risk_country_a_amt_7day_avg/high_risk_country_a_amt_15day_avg high_risk_country_a_amt_avg_7day_div_15day,
  high_risk_mcc_code_a_amt_1day_avg/high_risk_mcc_code_a_amt_7day_avg high_risk_mcc_code_a_amt_avg_1day_div_7day,
  high_risk_mcc_code_a_amt_7day_avg/high_risk_mcc_code_a_amt_15day_avg high_risk_mcc_code_a_amt_avg_7day_div_15day,
  
  china_amt_3num_avg/china_amt_7num_avg china_amt_avg_3num_div_7num,
  china_amt_7num_avg/china_amt_15num_avg china_amt_avg_7num_div_15num,
  aboard_amt_3num_avg/aboard_amt_7num_avg aboard_amt_avg_3num_div_7num,
  aboard_amt_7num_avg/aboard_amt_15num_avg aboard_amt_avg_7num_div_15num,
  high_risk_country_a_amt_3num_avg/high_risk_country_a_amt_7num_avg high_risk_country_a_amt_avg_3num_div_7num,
  high_risk_country_a_amt_7num_avg/high_risk_country_a_amt_15num_avg high_risk_country_a_amt_avg_7num_div_15num,
  high_risk_mcc_code_a_amt_3num_avg/high_risk_mcc_code_a_amt_7num_avg high_risk_mcc_code_a_amt_avg_3num_div_7num,
  high_risk_mcc_code_a_amt_7num_avg/high_risk_mcc_code_a_amt_15num_avg high_risk_mcc_code_a_amt_avg_7num_div_15num
from
  transaction_flow_test_time_feature
where 
  local_date >= "20180618" and md_tran_amt1 > 0





