create table if not exists transaction_flow(
dd_date                string,
sd_fiid                string,
sd_tran_cde            string,
md_tran_amt1           string,
md_tran_amt2           string,
md_tran_amt3           string,
sd_msg_typ             string,
sd_apprv_cde           string,
sd_resp_cde            string,
sd_crd_vrfy_flg        string,
sd_cvd_present_flg     string,
sd_orig_crncy_cde      string,
sd_acq_inst_id_num     string,
sd_frwd_inst_id_num    string,
sd_retl_id             string,
sd_pt_srv_cond_cde     string,
sd_pt_srv_entry_mde    string,
sd_pin_ind             string,
sd_e_com_flg           string,
sd_track1_2_ind        string,
sd_auth_src            string,
sd_acct_typ            string,
sd_acct_stat           string,
sd_term_id             string,
sd_term_name_loc       string,
sd_pan                 string,
sd_pin_verify_flag     string,
sd_orig_wir_cntry_cde  string,
sd_retl_sic_cde        string,
sd_trace_nbr           string,
sd_proc_cde            string,
sd_tran_cde_cat        string,
sd_tranrspout          string,
nd_sign_accu           string,
sd_pin_chk             string,
sd_pin_flag            string,
sd_prod_ind            string,
sd_cityno              string,
sd_icflg               string,
sd_fall_back           string,
sd_visaeci_flag        string,
sd_mcucaf_flag         string,
sd_moto_flag           string
)
row format delimited 
  fields terminated by '|' 
  lines terminated by '\n'
stored as textfile;

load data local inpath '/opt/data/test.txt' insert into transaction_flow;

create table if not exists transaction_flow_pre stored as parquet as select 
  dd_date,--授权时间
  md_tran_amt1,--消费金额
  sd_acq_inst_id_num,--受理机构代码
  sd_frwd_inst_id_num,--转发机构代码
  sd_pan,--卡号
  sd_trace_nbr,--前置机流水号
  sd_tran_cde_cat,--交易类别
  md_tran_amt3,--交易清算金额
  substr(dd_date,1,8) local_date,
  substr(dd_date,9,8) local_time,
  (((((substr(dd_date, 10, 2) + (substr(dd_date, 13, 2) / 60)) + (substr(dd_date, 16, 2) / 3600)) / 24) * 2) * 3.141592653589793) time_to_radian,
  unix_timestamp(substr(dd_date,1,17),"yyyyMMdd hh:mm:ss") local_unix_timestamp,
  sd_orig_crncy_cde,  --交易币种
  sd_orig_wir_cntry_cde,--交易国家代码
  sd_cityno,--交易城市代码
  sd_retl_sic_cde,--商户类型
  sd_retl_id,--商户代码
  case when sd_orig_wir_cntry_cde = 156 then md_tran_amt3 else 0.0 end china_amt,
  case when (not(sd_orig_wir_cntry_cde = 156)) then md_tran_amt3 else 0.0 end aboard_amt,
  case when (sd_orig_wir_cntry_cde in (840, 372, 250)) then md_tran_amt3 else 0.0 end high_risk_country_a_amt,
  case when (sd_retl_sic_cde in (5735, 4121)) then md_tran_amt3 else 0.0 end high_risk_mcc_code_a_amt
from 
  transaction_flow;
  
create table if not exists transaction_flow_time_feature stored as parquet as  select 
  dd_date,--授权时间
  md_tran_amt1,--消费金额
  sd_acq_inst_id_num,--受理机构代码
  sd_frwd_inst_id_num,--转发机构代码
  sd_pan,--卡号
  sd_trace_nbr,--前置机流水号
  sd_tran_cde_cat,--交易类别
  md_tran_amt3,--交易清算金额
  local_date,
  local_time,
  time_to_radian,
  local_unix_timestamp,
  sd_orig_crncy_cde,      --交易币种
  sd_orig_wir_cntry_cde,  --交易国家代码
  sd_cityno,--交易城市代码
  sd_retl_sic_cde,--商户类型
  sd_retl_id,--商户代码
  china_amt,
  aboard_amt,
  high_risk_country_a_amt,
  high_risk_mcc_code_a_amt,
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_amt_1hour_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) china_amt_1hour_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) aboard_amt_1hour_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_country_a_amt_1hour_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600 preceding and 1 preceding) high_risk_mcc_code_a_amt_1hour_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600 preceding and 1 preceding) retl_id_tran_amt_1hour_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600 preceding and 1 preceding) retl_id_tran_amt_1hour_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 3600 preceding and 1 preceding) tran_same_1hour_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600 preceding and 1 preceding) retl_id_same_1hour_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 3600 preceding and 1 preceding) cityno_same_1hour_count,
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) tran_amt_1day_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) tran_amt_1day_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) tran_amt_1day_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) tran_amt_1day_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) tran_amt_1day_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) china_amt_1day_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) china_amt_1day_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) china_amt_1day_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) china_amt_1day_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) aboard_amt_1day_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) aboard_amt_1day_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) aboard_amt_1day_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) aboard_amt_1day_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) high_risk_country_a_amt_1day_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) high_risk_country_a_amt_1day_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) high_risk_country_a_amt_1day_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) high_risk_country_a_amt_1day_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) high_risk_mcc_code_a_amt_1day_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) retl_id_tran_amt_1day_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) retl_id_tran_amt_1day_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) tran_same_1day_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) retl_id_same_1day_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 3600*24 preceding and 1 preceding) cityno_same_1day_count,
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) tran_amt_7day_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) tran_amt_7day_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) tran_amt_7day_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) tran_amt_7day_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) tran_amt_7day_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) china_amt_7day_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) china_amt_7day_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) china_amt_7day_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) china_amt_7day_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) aboard_amt_7day_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) aboard_amt_7day_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) aboard_amt_7day_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) aboard_amt_7day_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) high_risk_country_a_amt_7day_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) high_risk_country_a_amt_7day_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) high_risk_country_a_amt_7day_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) high_risk_country_a_amt_7day_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) high_risk_mcc_code_a_amt_7day_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) retl_id_tran_amt_7day_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) retl_id_tran_amt_7day_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) tran_same_7day_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) retl_id_same_7day_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 3600*24*7 preceding and 1 preceding) cityno_same_7day_count,
  
  count(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) tran_amt_15day_count,
  sum(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) tran_amt_15day_sum,
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) tran_amt_15day_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) tran_amt_15day_stddev,
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) tran_amt_15day_avg,
  count(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) china_amt_15day_count,
  sum(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) china_amt_15day_sum,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) china_amt_15day_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) china_amt_15day_avg,
  count(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) aboard_amt_15day_count,
  sum(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) aboard_amt_15day_sum,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) aboard_amt_15day_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) aboard_amt_15day_avg,
  count(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) high_risk_country_a_amt_15day_count,
  sum(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) high_risk_country_a_amt_15day_sum,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) high_risk_country_a_amt_15day_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) high_risk_country_a_amt_15day_avg,
  count(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_count,
  sum(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_sum,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) high_risk_mcc_code_a_amt_15day_avg,
  count(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) retl_id_tran_amt_15day_count,
  sum(md_tran_amt3) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) retl_id_tran_amt_15day_sum,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) tran_same_15day_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) retl_id_same_15day_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp range between 3600*24*15 preceding and 1 preceding) cityno_same_15day_count,
  
  (local_unix_timestamp-lag(local_unix_timestamp, 1, NULL) over (partition by sd_pan order by local_unix_timestamp)) trans_time_interval,
  lag(sd_orig_wir_cntry_cde, 1, NULL) over (partition by sd_pan order by local_unix_timestamp) before_time_country,
  
  
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 4 preceding and 1 preceding)  tran_amt_3num_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 4 preceding and 1 preceding) tran_amt_3num_stddev
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 4 preceding and 1 preceding) tran_amt_3num_avg,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 4 preceding and 1 preceding)  china_amt_3num_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 4 preceding and 1 preceding) china_amt_3num_avg,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 4 preceding and 1 preceding)  aboard_amt_3num_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 4 preceding and 1 preceding) aboard_amt_3num_avg,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 4 preceding and 1 preceding) high_risk_country_a_amt_3num_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 4 preceding and 1 preceding) high_risk_country_a_amt_3num_avg,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 4 preceding and 1 preceding) high_risk_mcc_code_a_amt_3num_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 4 preceding and 1 preceding) high_risk_mcc_code_a_amt_3num_avg,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp rows between 4 preceding and 1 preceding) tran_same_3num_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp rows between 4 preceding and 1 preceding) retl_id_same_3num_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp rows between 4 preceding and 1 preceding) cityno_same_3num_count,
  
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 8 preceding and 1 preceding)  tran_amt_7num_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 8 preceding and 1 preceding) tran_amt_7num_stddev
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 8 preceding and 1 preceding) tran_amt_7num_avg,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 8 preceding and 1 preceding)  china_amt_7num_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 8 preceding and 1 preceding) china_amt_7num_avg,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 8 preceding and 1 preceding)  aboard_amt_7num_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 8 preceding and 1 preceding) aboard_amt_7num_avg,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 8 preceding and 1 preceding) high_risk_country_a_amt_7num_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 8 preceding and 1 preceding) high_risk_country_a_amt_7num_avg,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 8 preceding and 1 preceding) high_risk_mcc_code_a_amt_7num_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 8 preceding and 1 preceding) high_risk_mcc_code_a_amt_7num_avg,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp rows between 8 preceding and 1 preceding) tran_same_7num_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp rows between 8 preceding and 1 preceding) retl_id_same_7num_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp rows between 8 preceding and 1 preceding) cityno_same_7num_count,
  
  max(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 16 preceding and 1 preceding)  tran_amt_15num_max,
  stddev(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 16 preceding and 1 preceding) tran_amt_15num_stddev
  avg(md_tran_amt3) over (partition by sd_pan order by local_unix_timestamp rows between 16 preceding and 1 preceding) tran_amt_15num_avg,
  max(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 16 preceding and 1 preceding)  china_amt_15num_max,
  avg(china_amt) over (partition by sd_pan order by local_unix_timestamp rows between 16 preceding and 1 preceding) china_amt_15num_avg,
  max(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 16 preceding and 1 preceding)  aboard_amt_15num_max,
  avg(aboard_amt) over (partition by sd_pan order by local_unix_timestamp rows between 16 preceding and 1 preceding) aboard_amt_15num_avg,
  max(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 16 preceding and 1 preceding) high_risk_country_a_amt_15num_max,
  avg(high_risk_country_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 16 preceding and 1 preceding) high_risk_country_a_amt_15num_avg,
  max(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 16 preceding and 1 preceding) high_risk_mcc_code_a_amt_15num_max,
  avg(high_risk_mcc_code_a_amt) over (partition by sd_pan order by local_unix_timestamp rows between 16 preceding and 1 preceding) high_risk_mcc_code_a_amt_15num_avg,
  count(md_tran_amt3) over (partition by sd_pan,md_tran_amt3 order by local_unix_timestamp rows between 16 preceding and 1 preceding) tran_same_15num_count,
  count(sd_retl_id) over (partition by sd_pan,sd_retl_id order by local_unix_timestamp rows between 16 preceding and 1 preceding) retl_id_same_15num_count,
  count(sd_cityno) over (partition by sd_pan,sd_cityno order by local_unix_timestamp rows between 16 preceding and 1 preceding) cityno_same_15num_count,
  
  case when (sd_orig_wir_cntry_cde - lag(sd_orig_wir_cntry_cde, 1, NULL) over (partition by sd_pan order by local_unix_timestamp))=0 then 1 else 0 end cntry_cde_before_same,
  case when (lag(china_amt, 1, NULL) over (partition by sd_pan order by local_unix_timestamp)>0 && china_amt>0) then 1 else 0 end cntry_cde_before_same_china,
  
  lag(md_tran_amt3, 1, NULL) over (partition by sd_pan order by local_unix_timestamp) before_tran_amt
from
  transaction_flow_pre,
  
create table if not exists feature_final stored as parquet as select 
  dd_date,--授权时间
  md_tran_amt1,--消费金额
  sd_acq_inst_id_num,--受理机构代码
  sd_frwd_inst_id_num,--转发机构代码
  sd_pan,--卡号
  sd_trace_nbr,--前置机流水号
  sd_tran_cde_cat,--交易类别
  md_tran_amt3,--交易清算金额
  local_date,
  local_time,
  time_to_radian,
  local_unix_timestamp,
  sd_orig_crncy_cde,      --交易币种
  sd_orig_wir_cntry_cde,  --交易国家代码
  sd_cityno,--交易城市代码
  sd_retl_sic_cde,--商户类型
  sd_retl_id,--商户代码
  china_amt,
  aboard_amt,
  high_risk_country_a_amt,
  high_risk_mcc_code_a_amt,
  tran_amt_1hour_count,
  tran_amt_1hour_sum,
  tran_amt_1hour_max,
  tran_amt_1hour_stddev,
  tran_amt_1hour_avg,
  china_amt_1hour_count,
  china_amt_1hour_sum,
  china_amt_1hour_max,
  china_amt_1hour_avg,
  aboard_amt_1hour_count,
  aboard_amt_1hour_sum,
  aboard_amt_1hour_max,
  aboard_amt_1hour_avg,
  high_risk_country_a_amt_1hour_count,
  high_risk_country_a_amt_1hour_sum,
  high_risk_country_a_amt_1hour_max,
  high_risk_country_a_amt_1hour_avg,
  high_risk_mcc_code_a_amt_1hour_count,
  high_risk_mcc_code_a_amt_1hour_sum,
  high_risk_mcc_code_a_amt_1hour_max,
  high_risk_mcc_code_a_amt_1hour_avg,
  retl_id_tran_amt_1hour_count,
  retl_id_tran_amt_1hour_sum,
  tran_same_1hour_count,
  retl_id_same_1hour_count,
  cityno_same_1hour_count,
  tran_amt_1day_count,
  tran_amt_1day_sum,
  tran_amt_1day_max,
  tran_amt_1day_stddev,
  tran_amt_1day_avg,
  china_amt_1day_count,
  china_amt_1day_sum,
  china_amt_1day_max,
  china_amt_1day_avg,
  aboard_amt_1day_count,
  aboard_amt_1day_sum,
  aboard_amt_1day_max,
  aboard_amt_1day_avg,
  high_risk_country_a_amt_1day_count,
  high_risk_country_a_amt_1day_sum,
  high_risk_country_a_amt_1day_max,
  high_risk_country_a_amt_1day_avg,
  high_risk_mcc_code_a_amt_1day_count,
  high_risk_mcc_code_a_amt_1day_sum,
  high_risk_mcc_code_a_amt_1day_max,
  high_risk_mcc_code_a_amt_1day_avg,
  retl_id_tran_amt_1day_count,
  retl_id_tran_amt_1day_sum,
  tran_same_1day_count,
  retl_id_same_1day_count,
  cityno_same_1day_count,
  
  tran_amt_7day_count,
  tran_amt_7day_sum,
  tran_amt_7day_max,
  tran_amt_7day_stddev,
  tran_amt_7day_avg,
  china_amt_7day_count,
  china_amt_7day_sum,
  china_amt_7day_max,
  china_amt_7day_avg,
  aboard_amt_7day_count,
  aboard_amt_7day_sum,
  aboard_amt_7day_max,
  aboard_amt_7day_avg,
  high_risk_country_a_amt_7day_count,
  high_risk_country_a_amt_7day_sum,
  high_risk_country_a_amt_7day_max,
  high_risk_country_a_amt_7day_avg,
  high_risk_mcc_code_a_amt_7day_count,
  high_risk_mcc_code_a_amt_7day_sum,
  high_risk_mcc_code_a_amt_7day_max,
  high_risk_mcc_code_a_amt_7day_avg,
  retl_id_tran_amt_7day_count,
  retl_id_tran_amt_7day_sum,
  tran_same_7day_count,
  retl_id_same_7day_count,
  cityno_same_7day_count,
  
  tran_amt_15day_count,
  tran_amt_15day_sum,
  tran_amt_15day_max,
  tran_amt_15day_stddev,
  tran_amt_15day_avg,
  china_amt_15day_count,
  china_amt_15day_sum,
  china_amt_15day_max,
  china_amt_15day_avg,
  aboard_amt_15day_count,
  aboard_amt_15day_sum,
  aboard_amt_15day_max,
  aboard_amt_15day_avg,
  high_risk_country_a_amt_15day_count,
  high_risk_country_a_amt_15day_sum,
  high_risk_country_a_amt_15day_max,
  high_risk_country_a_amt_15day_avg,
  high_risk_mcc_code_a_amt_15day_count,
  high_risk_mcc_code_a_amt_15day_sum,
  high_risk_mcc_code_a_amt_15day_max,
  high_risk_mcc_code_a_amt_15day_avg,
  retl_id_tran_amt_15day_count,
  retl_id_tran_amt_15day_sum,
  tran_same_15day_count,
  retl_id_same_15day_count,
  cityno_same_15day_count,
  
  tran_amt_3num_max,
  tran_amt_3num_stddev
  tran_amt_3num_avg,
  china_amt_3num_max,
  china_amt_3num_avg,
  aboard_amt_3num_max,
  aboard_amt_3num_avg,
  high_risk_country_a_amt_3num_max,
  high_risk_country_a_amt_3num_avg,
  high_risk_mcc_code_a_amt_3num_max,
  high_risk_mcc_code_a_amt_3num_avg,
  tran_same_3num_count,
  retl_id_same_3num_count,
  cityno_same_3num_count,
  
  tran_amt_7num_max,
  tran_amt_7num_stddev
  tran_amt_7num_avg,
  china_amt_7num_max,
  china_amt_7num_avg,
  aboard_amt_7num_max,
  aboard_amt_7num_avg,
  high_risk_country_a_amt_7num_max,
  high_risk_country_a_amt_7num_avg,
  high_risk_mcc_code_a_amt_7num_max,
  high_risk_mcc_code_a_amt_7num_avg,
  tran_same_7num_count,
  retl_id_same_7num_count,
  cityno_same_7num_count,
  
  tran_amt_15num_max,
  tran_amt_15num_stddev
  tran_amt_15num_avg,
  china_amt_15num_max,
  china_amt_15num_avg,
  aboard_amt_15num_max,
  aboard_amt_15num_avg,
  high_risk_country_a_amt_15num_max,
  high_risk_country_a_amt_15num_avg,
  high_risk_mcc_code_a_amt_15num_max,
  high_risk_mcc_code_a_amt_15num_avg,
  tran_same_15num_count,
  retl_id_same_15num_count,
  cityno_same_15num_count,
  
  cntry_cde_before_same,
  cntry_cde_before_same_china,
  before_tran_amt,
  (md_tran_amt3 / tran_amt_3num_avg) consume_amt_div_avg_3num,
  (md_tran_amt3 / tran_amt_3num_max) consume_amt_div_max_3num,
  (md_tran_amt3 / tran_amt_7num_avg) consume_amt_div_avg_7num,
  (md_tran_amt3 / tran_amt_7num_max) consume_amt_div_max_7num,
  (md_tran_amt3 / tran_amt_15num_avg) consume_amt_div_avg_15num,
  (md_tran_amt3 / tran_amt_15num_max) consume_amt_div_max_15num,
  (md_tran_amt3 / before_tran_amt) before_tran_amt_rate,
  (md_tran_amt3-tran_amt_15num_avg)/tran_amt_15num_stddev consume_amt_avg_div_stddev_15num,
  china_amt_1day_avg/china_amt_7day_avg china_amt_avg_1day_div_7day,
  china_amt_7day_avg/china_amt_15day_avg china_amt_avg_7day_div_15day,
  aboard_amt_1day_avg/aboard_amt_7day_avg aboard_amt_avg_1day_div_7day,
  aboard_amt_7day_avg/aboard_amt_15day_avg aboard_amt_avg_7day_div_15day,
  high_risk_country_a_amt_1day_avg/high_risk_country_a_amt_7day_avg high_risk_country_a_amt_avg_1day_div_7day,
  high_risk_country_a_amt_7day_avg/high_risk_country_a_amt_15day_avg high_risk_country_a_amt_avg_7day_div_15day,
  high_risk_mcc_code_a_amt_1day_avg/high_risk_mcc_code_a_amt_7day_avg high_risk_mcc_code_a_amt_avg_1day_div_7day,
  high_risk_mcc_code_a_amt_7day_avg/high_risk_mcc_code_a_amt_15day_avg high_risk_mcc_code_a_amt_avg_7day_div_15day,
  
  china_amt_3num_avg/china_amt_7num_avg china_amt_avg_3num_div_7num,
  china_amt_7num_avg/china_amt_15num_avg china_amt_avg_7num_div_15num,
  aboard_amt_3num_avg/aboard_amt_7num_avg aboard_amt_avg_3num_div_7num,
  aboard_amt_7num_avg/aboard_amt_15num_avg aboard_amt_avg_7num_div_15num,
  high_risk_country_a_amt_3num_avg/high_risk_country_a_amt_7num_avg high_risk_country_a_amt_avg_3num_div_7num,
  high_risk_country_a_amt_7num_avg/high_risk_country_a_amt_15num_avg high_risk_country_a_amt_avg_7num_div_15num,
  high_risk_mcc_code_a_amt_3num_avg/high_risk_mcc_code_a_amt_7num_avg high_risk_mcc_code_a_amt_avg_3num_div_7num,
  high_risk_mcc_code_a_amt_7num_avg/high_risk_mcc_code_a_amt_15num_avg high_risk_mcc_code_a_amt_avg_7num_div_15num
from
  transaction_flow_time_feature;

